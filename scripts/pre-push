#!/bin/sh
# pre-push hook — auto-installs prek if missing, then runs file-hygiene
# checks on ALL files before pushing.
#
# Managed by scripts/prepare-hooks.js (re-created on `npm install`).

set -e

# ── Auto-install prek if not on PATH ──────────────────────────────
if ! command -v prek >/dev/null 2>&1; then
  echo "[pre-push] prek not found — installing…"
  curl -LsSf https://github.com/j178/prek/releases/latest/download/prek-installer.sh | sh
  # Refresh PATH for cargo-installed binaries
  export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"
  if ! command -v prek >/dev/null 2>&1; then
    echo "[pre-push] ⚠ Could not install prek. Skipping hooks."
    exit 0
  fi
  echo "[pre-push] prek installed ✓"
fi

echo "[pre-push] Running file-hygiene checks on all files…"

# Run only the fast file-hygiene hooks (not the full build/test suite)
prek run \
  trailing-whitespace \
  end-of-file-fixer \
  check-yaml \
  check-json \
  check-toml \
  check-merge-conflict \
  mixed-line-ending \
  --all-files

echo "[pre-push] All checks passed ✓"
