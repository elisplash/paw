// Claw Desktop - Main Application

// Tauri API types
interface TauriWindow {
  __TAURI__?: {
    core: {
      invoke: <T>(cmd: string, args?: Record<string, unknown>) => Promise<T>;
    };
    event: {
      listen: <T>(event: string, handler: (event: { payload: T }) => void) => Promise<() => void>;
    };
  };
}

const tauriWindow = window as unknown as TauriWindow;
const invoke = tauriWindow.__TAURI__?.core?.invoke;
const listen = tauriWindow.__TAURI__?.event?.listen;

interface Config {
  configured: boolean;
  gateway: {
    url: string;
    token: string;
  };
}

interface Message {
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

interface InstallProgress {
  stage: string;
  percent: number;
  message: string;
}

// State
let config: Config = {
  configured: false,
  gateway: {
    url: 'http://localhost:5757',
    token: '',
  },
};

let messages: Message[] = [];
let isLoading = false;

// DOM Elements (safe - may be null)
const setupView = document.getElementById('setup-view');
const manualSetupView = document.getElementById('manual-setup-view');
const installView = document.getElementById('install-view');
const chatView = document.getElementById('chat-view');
const agentsView = document.getElementById('agents-view');
const channelsView = document.getElementById('channels-view');
const memoryView = document.getElementById('memory-view');
const cronView = document.getElementById('cron-view');
const settingsView = document.getElementById('settings-view');
const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');
const chatMessages = document.getElementById('chat-messages');
const chatEmpty = document.getElementById('chat-empty');
const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement | null;
const chatSend = document.getElementById('chat-send') as HTMLButtonElement | null;

const allViews = [setupView, manualSetupView, installView, chatView, agentsView, channelsView, memoryView, cronView, settingsView].filter(Boolean);

// Navigation
document.querySelectorAll('.nav-item').forEach((item) => {
  item.addEventListener('click', () => {
    const view = item.getAttribute('data-view');
    if (view) switchView(view);
  });
});

function switchView(viewName: string) {
  if (!config.configured && viewName !== 'settings') {
    return;
  }

  document.querySelectorAll('.nav-item').forEach((item) => {
    item.classList.toggle('active', item.getAttribute('data-view') === viewName);
  });

  allViews.forEach((v) => v?.classList.remove('active'));

  switch (viewName) {
    case 'chat':
      chatView?.classList.add('active');
      break;
    case 'agents':
      agentsView?.classList.add('active');
      break;
    case 'channels':
      channelsView?.classList.add('active');
      break;
    case 'memory':
      memoryView?.classList.add('active');
      break;
    case 'cron':
      cronView?.classList.add('active');
      break;
    case 'settings':
      settingsView?.classList.add('active');
      syncSettingsForm();
      break;
  }
}

function showView(viewId: string) {
  allViews.forEach((v) => v?.classList.remove('active'));
  document.getElementById(viewId)?.classList.add('active');
}

// Setup handlers
document.getElementById('setup-detect')?.addEventListener('click', async () => {
  if (statusText) statusText.textContent = 'Detecting...';
  
  try {
    // Check if OpenClaw is installed
    const installed = invoke ? await invoke<boolean>('check_openclaw_installed') : false;
    
    if (installed) {
      // Get the token
      const token = invoke ? await invoke<string | null>('get_gateway_token') : null;
      
      if (token) {
        config.configured = true;
        config.gateway.url = 'http://localhost:5757';
        config.gateway.token = token;
        saveConfig();
        
        // Start gateway if not running
        if (invoke) {
          await invoke('start_gateway');
        }
        
        // Wait a moment for gateway to start
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        await checkGatewayStatus();
        switchView('chat');
        return;
      }
    }
    
    // Not installed - show install view
    showView('install-view');
    
  } catch (error) {
    console.error('Detection error:', error);
    alert('Could not detect OpenClaw. Try manual setup or install.');
  }
});

document.getElementById('setup-manual')?.addEventListener('click', () => {
  showView('manual-setup-view');
});

document.getElementById('setup-new')?.addEventListener('click', () => {
  showView('install-view');
});

document.getElementById('gateway-back')?.addEventListener('click', () => {
  showView('setup-view');
});

document.getElementById('install-back')?.addEventListener('click', () => {
  showView('setup-view');
});

// Install OpenClaw
document.getElementById('start-install')?.addEventListener('click', async () => {
  const progressBar = document.getElementById('install-progress-bar') as HTMLElement;
  const progressText = document.getElementById('install-progress-text') as HTMLElement;
  const installBtn = document.getElementById('start-install') as HTMLButtonElement;
  
  installBtn.disabled = true;
  installBtn.textContent = 'Installing...';
  
  try {
    // Listen for progress events
    if (listen) {
      await listen<InstallProgress>('install-progress', (event: { payload: InstallProgress }) => {
        const { percent, message } = event.payload;
        if (progressBar) progressBar.style.width = `${percent}%`;
        if (progressText) progressText.textContent = message;
      });
    }
    
    // Start installation
    if (invoke) {
      await invoke('install_openclaw');
    }
    
    // Get the token after install
    const token = invoke ? await invoke<string | null>('get_gateway_token') : null;
    
    if (token) {
      config.configured = true;
      config.gateway.url = 'http://localhost:5757';
      config.gateway.token = token;
      saveConfig();
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      await checkGatewayStatus();
      switchView('chat');
    }
    
  } catch (error) {
    console.error('Install error:', error);
    if (progressText) progressText.textContent = `Error: ${error}`;
    installBtn.disabled = false;
    installBtn.textContent = 'Retry Installation';
  }
});

// Gateway form
document.getElementById('gateway-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const url = (document.getElementById('gateway-url') as HTMLInputElement).value;
  const token = (document.getElementById('gateway-token') as HTMLInputElement).value;
  
  // Test connection
  try {
    const response = await fetch(`${url}/health`, {
      signal: AbortSignal.timeout(3000),
    });
    
    if (response.ok) {
      config.configured = true;
      config.gateway = { url, token };
      saveConfig();
      
      if (statusDot) statusDot.classList.add('connected');
      if (statusText) statusText.textContent = 'Connected';
      
      switchView('chat');
    } else {
      throw new Error('Gateway not responding');
    }
  } catch (error) {
    alert('Could not connect to gateway. Check URL and try again.');
  }
});

// Settings Form
function syncSettingsForm() {
  const urlInput = document.getElementById('settings-gateway-url') as HTMLInputElement;
  const tokenInput = document.getElementById('settings-gateway-token') as HTMLInputElement;
  if (urlInput) urlInput.value = config.gateway.url;
  if (tokenInput) tokenInput.value = config.gateway.token;
}

document.getElementById('settings-save-gateway')?.addEventListener('click', async () => {
  const url = (document.getElementById('settings-gateway-url') as HTMLInputElement).value;
  const token = (document.getElementById('settings-gateway-token') as HTMLInputElement).value;
  
  try {
    const response = await fetch(`${url}/health`, {
      signal: AbortSignal.timeout(3000),
    });
    
    if (response.ok) {
      config.gateway = { url, token };
      saveConfig();
      
      if (statusDot) statusDot.classList.add('connected');
      if (statusDot) statusDot.classList.remove('error');
      if (statusText) statusText.textContent = 'Connected';
      
      alert('Settings saved!');
    } else {
      throw new Error('Not OK');
    }
  } catch {
    alert('Could not connect to gateway with these settings.');
  }
});

// Config persistence
function saveConfig() {
  localStorage.setItem('claw-config', JSON.stringify(config));
}

function loadConfig() {
  const saved = localStorage.getItem('claw-config');
  if (saved) {
    try {
      config = JSON.parse(saved);
    } catch {
      // Invalid config
    }
  }
}

// Chat functionality
chatSend?.addEventListener('click', sendMessage);
chatInput?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

chatInput?.addEventListener('input', () => {
  if (chatInput) {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
  }
});

document.getElementById('new-chat-btn')?.addEventListener('click', () => {
  messages = [];
  renderMessages();
});

async function sendMessage() {
  const content = chatInput?.value.trim();
  if (!content || isLoading) return;

  addMessage({ role: 'user', content, timestamp: new Date() });
  if (chatInput) chatInput.value = '';
  if (chatInput) chatInput.style.height = 'auto';

  isLoading = true;
  if (chatSend) chatSend.disabled = true;
  showLoading();

  try {
    const response = await callGateway(content);
    hideLoading();
    addMessage({ role: 'assistant', content: response, timestamp: new Date() });
  } catch (error) {
    console.error('Error:', error);
    hideLoading();
    addMessage({
      role: 'assistant',
      content: `Error: ${error instanceof Error ? error.message : 'Failed to get response'}`,
      timestamp: new Date(),
    });
  } finally {
    isLoading = false;
    if (chatSend) chatSend.disabled = false;
  }
}

function addMessage(message: Message) {
  messages.push(message);
  renderMessages();
}

function renderMessages() {
  if (messages.length === 0) {
    if (chatEmpty) chatEmpty.style.display = 'flex';
    return;
  }

  if (chatEmpty) chatEmpty.style.display = 'none';

  const existingMessages = chatMessages?.querySelectorAll('.message');
  existingMessages?.forEach((m) => m.remove());

  messages.forEach((msg) => {
    const div = document.createElement('div');
    div.className = `message ${msg.role}`;

    const content = document.createElement('div');
    content.className = 'message-content';
    content.textContent = msg.content;

    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    div.appendChild(content);
    div.appendChild(time);
    chatMessages?.appendChild(div);
  });

  if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showLoading() {
  if (chatEmpty) chatEmpty.style.display = 'none';
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'message assistant';
  loadingDiv.id = 'loading-message';
  loadingDiv.innerHTML = `
    <div class="message-content">
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  `;
  chatMessages?.appendChild(loadingDiv);
  if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideLoading() {
  document.getElementById('loading-message')?.remove();
}

async function callGateway(userMessage: string): Promise<string> {
  // Try the webchat endpoint first
  const response = await fetch(`${config.gateway.url}/webchat/send`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      message: userMessage,
    }),
  });

  if (!response.ok) {
    throw new Error(`Gateway error: ${response.status}`);
  }

  const data = await response.json();
  return data.response || data.message || data.content || 'No response';
}

async function checkGatewayStatus() {
  try {
    const response = await fetch(`${config.gateway.url}/health`, {
      signal: AbortSignal.timeout(2000),
    });
    
    if (response.ok) {
      statusDot?.classList.add('connected');
      statusDot?.classList.remove('error');
      if (statusText) statusText.textContent = 'Connected';
    } else {
      throw new Error('Not OK');
    }
  } catch {
    statusDot?.classList.remove('connected');
    statusDot?.classList.add('error');
    if (statusText) statusText.textContent = 'Disconnected';
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  try {
    console.log('Claw Desktop starting...');
    loadConfig();

    if (config.configured) {
      switchView('chat');
      checkGatewayStatus();
    } else {
      showView('setup-view');
    }

    setInterval(checkGatewayStatus, 10000);
    console.log('Claw Desktop initialized');
  } catch (e) {
    console.error('Init error:', e);
    showView('setup-view');
  }
});
