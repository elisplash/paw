<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenPawz</title>
    <link rel="stylesheet" href="/src/styles/index.css" />
  </head>
  <body>
    <!-- ═══ Lock Screen ═══ -->
    <div class="lock-screen" id="lock-screen">
      <div class="lock-screen-inner">
        <div class="lock-logo">
          <div class="lock-logo-icon"></div>
        </div>
        <h1 class="lock-title">OpenPawz</h1>
        <p class="lock-subtitle" id="lock-subtitle">Verify your identity</p>

        <!-- System auth form (Touch ID / system password) -->
        <div class="lock-form" id="lock-form-system" style="display:none">
          <button class="lock-system-btn" id="lock-system-btn">
            <span class="ms">lock</span>
            <span>Unlock with System Password</span>
          </button>
          <p class="lock-error" id="lock-system-error"></p>
        </div>

        <!-- Divider between system auth and passphrase (shown when both available) -->
        <div class="lock-divider" id="lock-divider" style="display:none">
          <span>or</span>
        </div>

        <!-- Passphrase unlock form (returning user) -->
        <div class="lock-form" id="lock-form-unlock" style="display:none">
          <div class="lock-input-group">
            <input type="password" class="lock-input" id="lock-password" placeholder="Passphrase" autocomplete="off" spellcheck="false" />
            <button class="lock-submit" id="lock-submit" title="Unlock">
              <span class="ms ms-sm">lock_open</span>
            </button>
          </div>
          <p class="lock-error" id="lock-error"></p>
        </div>

        <!-- Lock screen footer links -->
        <div class="lock-footer-links" id="lock-footer-links" style="display:none">
          <a class="lock-switch-link" id="lock-reset">Reset lock screen</a>
        </div>

        <!-- First-time setup form -->
        <div class="lock-form" id="lock-form-setup" style="display:none">
          <div class="lock-auth-options" id="lock-auth-options">
            <button class="lock-auth-option" id="lock-opt-system">
              <span class="ms">lock</span>
              <span class="lock-auth-option-label">System Authentication</span>
              <span class="lock-auth-option-desc">Mac password or Touch ID</span>
            </button>
            <button class="lock-auth-option" id="lock-opt-passphrase">
              <span class="ms">password</span>
              <span class="lock-auth-option-label">Custom Passphrase</span>
              <span class="lock-auth-option-desc">Set your own code</span>
            </button>
            <button class="lock-auth-option" id="lock-opt-both">
              <span class="ms">security</span>
              <span class="lock-auth-option-label">Both</span>
              <span class="lock-auth-option-desc">System auth + passphrase as backup</span>
            </button>
            <button class="lock-auth-option lock-auth-option-skip" id="lock-opt-skip">
              <span class="ms">lock_open</span>
              <span class="lock-auth-option-label">No Protection</span>
              <span class="lock-auth-option-desc">Skip lock screen</span>
            </button>
          </div>
          <!-- Passphrase sub-form (shown after clicking "Custom Passphrase" or "Both") -->
          <div id="lock-passphrase-subform" style="display:none">
            <div class="lock-input-group">
              <input type="password" class="lock-input" id="lock-new-password" placeholder="New passphrase" autocomplete="off" spellcheck="false" />
            </div>
            <div class="lock-input-group" style="margin-top:8px">
              <input type="password" class="lock-input" id="lock-confirm-password" placeholder="Confirm passphrase" autocomplete="off" spellcheck="false" />
              <button class="lock-submit" id="lock-setup-submit" title="Set passphrase">
                <span class="ms ms-sm">shield</span>
              </button>
            </div>
            <p class="lock-error" id="lock-setup-error"></p>
            <a class="lock-switch-link" id="lock-setup-back">Back to options</a>
          </div>
        </div>

        <p class="lock-hint">Secured by OS Keychain</p>
      </div>
    </div>

    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-brand">
            <div class="sidebar-logo"></div>
            <span class="sidebar-title">Pawz</span>
          </div>
          <div class="sidebar-header-actions">
            <button class="sidebar-notification-btn" id="notification-bell" title="Notifications">
              <span class="ms ms-sm">notifications</span>
              <span class="notification-badge" id="notification-badge" style="display: none">0</span>
            </button>
            <button class="sidebar-collapse-btn" id="sidebar-collapse-btn" title="Collapse sidebar">
              <span class="ms ms-sm">chevron_left</span>
            </button>
          </div>
        </div>

        <!-- Notification Drawer -->
        <div class="notification-drawer" id="notification-drawer" style="display: none">
          <div class="notification-drawer-header">
            <span class="notification-drawer-title">Notifications</span>
            <button class="btn btn-ghost btn-sm" id="notification-clear-btn" title="Clear all">
              Clear
            </button>
          </div>
          <div class="notification-drawer-list" id="notification-drawer-list">
            <div class="notification-empty">No notifications</div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-item active" data-view="today">
              <span class="ms nav-icon">dashboard</span>
              <span class="nav-label">Today</span>
            </div>
            <div class="nav-item" data-view="chat">
              <span class="ms nav-icon">terminal</span>
              <span class="nav-label">Chat</span>
            </div>
            <div class="nav-item" data-view="agents">
              <span class="ms nav-icon">smart_toy</span>
              <span class="nav-label">Agents</span>
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-label">Work</div>
            <div class="nav-item" data-view="tasks">
              <span class="ms nav-icon">task_alt</span>
              <span class="nav-label">Tasks</span>
            </div>
            <div class="nav-item" data-view="flows">
              <span class="ms nav-icon">account_tree</span>
              <span class="nav-label">Flows</span>
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-label">Connect</div>
            <div class="nav-item" data-view="integrations">
              <span class="ms nav-icon">hub</span>
              <span class="nav-label">Integrations</span>
            </div>
            <div class="nav-item" data-view="mail">
              <span class="ms nav-icon">mail</span>
              <span class="nav-label">Mail</span>
            </div>
            <div class="nav-item" data-view="channels">
              <span class="ms nav-icon">forum</span>
              <span class="nav-label">Channels</span>
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-label">Workspace</div>
            <div class="nav-item" data-view="skills">
              <span class="ms nav-icon">auto_stories</span>
              <span class="nav-label">Skills</span>
            </div>
            <div class="nav-item" data-view="foundry">
              <span class="ms nav-icon">precision_manufacturing</span>
              <span class="nav-label">Foundry</span>
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-label">System</div>
            <div class="nav-item" data-view="settings">
              <span class="ms nav-icon">settings</span>
              <span class="nav-label">Settings</span>
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <button class="sidebar-theme-toggle" id="sidebar-theme-toggle" title="Toggle theme">
            <span class="ms nav-icon">dark_mode</span>
          </button>
          <div class="status-indicator">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Connecting...</span>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main">
        <!-- DB initialization error banner -->
        <div class="db-error-banner" id="db-error-banner" style="display: none">
          <span class="ms ms-sm">error</span>
          <span id="db-error-message"
            >Database failed to initialize — features requiring storage will not work.</span
          >
          <button class="btn btn-ghost btn-sm" id="db-error-retry" title="Retry">Retry</button>
          <button class="btn btn-ghost btn-sm" id="db-error-dismiss" title="Dismiss">×</button>
        </div>

        <!-- Global encryption warning banner (shown when OS keychain unavailable) -->
        <div class="encryption-warning-banner" id="encryption-warning-banner" style="display: none">
          <span class="ms ms-sm">warning</span>
          <span
            >OS keychain unavailable — credential storage is blocked and sensitive fields cannot be
            encrypted. Check your keychain provider (GNOME Keyring, KWallet, or macOS
            Keychain).</span
          >
          <button class="btn btn-ghost btn-sm" id="encryption-warning-dismiss" title="Dismiss">
            ×
          </button>
        </div>

        <!-- ═══ Onboarding Wizard ═══ -->
        <div class="view setup-view" id="setup-view">
          <div class="setup-card wizard-card">
            <!-- Progress bar -->
            <div class="wizard-progress">
              <div class="wizard-progress-fill" id="wizard-progress-fill"></div>
            </div>

            <!-- Step 1: Welcome -->
            <div class="wizard-step" id="wizard-step-1">
              <div class="setup-header">
                <div class="setup-icon">
                  <span class="ms" style="font-size: 48px">layers</span>
                </div>
                <h1 class="setup-title">Welcome to OpenPawz</h1>
                <p class="setup-subtitle">Your open-source AI agent platform. Let's get you set up in under a minute.</p>
              </div>
              <div class="wizard-features">
                <div class="wizard-feature"><span class="ms ms-sm">smart_toy</span> Multi-agent fleet with custom personas</div>
                <div class="wizard-feature"><span class="ms ms-sm">extension</span> 200+ integrations &amp; skills</div>
                <div class="wizard-feature"><span class="ms ms-sm">lock</span> Runs locally — your data stays yours</div>
              </div>
              <div class="wizard-actions">
                <button class="btn btn-primary wizard-btn-lg" id="wizard-start">Get Started</button>
              </div>
            </div>

            <!-- Step 2: Choose Provider -->
            <div class="wizard-step wizard-hidden" id="wizard-step-2">
              <div class="setup-header">
                <div class="setup-icon">
                  <span class="ms" style="font-size: 48px">hub</span>
                </div>
                <h1 class="setup-title">Choose Your AI Provider</h1>
                <p class="setup-subtitle">You need at least one AI provider to power your agents.</p>
              </div>

              <!-- Ollama recommendation -->
              <div class="wizard-recommend" id="wizard-ollama-section">
                <div class="wizard-recommend-badge">RECOMMENDED — FREE &amp; PRIVATE</div>
                <div class="wizard-recommend-body">
                  <div class="wizard-recommend-info">
                    <div class="wizard-recommend-title"><span class="ms ms-sm">computer</span> Ollama (Local AI)</div>
                    <div class="wizard-recommend-desc">Run AI models entirely on your machine. No API keys, no costs, complete privacy.</div>
                  </div>
                  <div class="wizard-ollama-status" id="wizard-ollama-status">
                    <span class="today-loading">Checking…</span>
                  </div>
                </div>
              </div>

              <div class="wizard-divider"><span>or use a cloud provider</span></div>

              <div class="wizard-providers">
                <button class="wizard-provider-btn" data-provider="openai">
                  <span class="wizard-provider-name">OpenAI</span>
                  <span class="wizard-provider-models">GPT-4o, o1, o3</span>
                </button>
                <button class="wizard-provider-btn" data-provider="anthropic">
                  <span class="wizard-provider-name">Anthropic</span>
                  <span class="wizard-provider-models">Claude 4, Sonnet</span>
                </button>
                <button class="wizard-provider-btn" data-provider="google">
                  <span class="wizard-provider-name">Google</span>
                  <span class="wizard-provider-models">Gemini 2.5</span>
                </button>
                <button class="wizard-provider-btn" data-provider="deepseek">
                  <span class="wizard-provider-name">DeepSeek</span>
                  <span class="wizard-provider-models">DeepSeek R1, V3</span>
                </button>
                <button class="wizard-provider-btn" data-provider="openrouter">
                  <span class="wizard-provider-name">OpenRouter</span>
                  <span class="wizard-provider-models">All models, one key</span>
                </button>
                <button class="wizard-provider-btn" data-provider="grok">
                  <span class="wizard-provider-name">Grok</span>
                  <span class="wizard-provider-models">Grok 3</span>
                </button>
              </div>

              <div class="wizard-actions">
                <button class="btn btn-ghost" id="wizard-back-2">Back</button>
              </div>
            </div>

            <!-- Step 3: API Key Entry (for cloud providers) -->
            <div class="wizard-step wizard-hidden" id="wizard-step-3">
              <div class="setup-header">
                <div class="setup-icon">
                  <span class="ms" style="font-size: 48px">vpn_key</span>
                </div>
                <h1 class="setup-title" id="wizard-key-title">Enter API Key</h1>
                <p class="setup-subtitle" id="wizard-key-subtitle">Paste your API key below. It's stored locally and never leaves your machine.</p>
              </div>

              <div class="wizard-form">
                <label class="wizard-label" for="wizard-api-key">API Key</label>
                <input type="password" class="form-input wizard-input" id="wizard-api-key" placeholder="sk-..." autocomplete="off" spellcheck="false">
                <div class="wizard-key-help" id="wizard-key-help"></div>
              </div>

              <div class="wizard-actions">
                <button class="btn btn-ghost" id="wizard-back-3">Back</button>
                <button class="btn btn-primary" id="wizard-save-key" disabled>Connect Provider</button>
              </div>
            </div>

            <!-- Step 4: All Done -->
            <div class="wizard-step wizard-hidden" id="wizard-step-4">
              <div class="setup-header">
                <div class="setup-icon wizard-icon-success">
                  <span class="ms" style="font-size: 48px">check_circle</span>
                </div>
                <h1 class="setup-title">You're All Set!</h1>
                <p class="setup-subtitle" id="wizard-done-subtitle">OpenPawz is configured and ready to go.</p>
              </div>

              <div class="wizard-summary" id="wizard-summary"></div>

              <div class="wizard-actions">
                <button class="btn btn-primary wizard-btn-lg" id="wizard-finish">Launch Mission Control</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Integrations View ═══ -->
        <div class="view integrations-view" id="integrations-view">
          <!-- Hero header -->
          <div class="integrations-hero">
            <div class="integrations-hero-left">
              <h1 class="integrations-hero-title">Integration Hub</h1>
              <p class="integrations-hero-sub">25,000+ services via n8n, MCP servers, and community packages — all your agent's tools in one place.</p>
            </div>
            <div class="integrations-hero-right">
              <div class="integrations-hero-stat k-row k-spring">
                <span class="ms integrations-hero-stat-icon">extension</span>
                <div>
                  <div class="integrations-hero-stat-val" id="integrations-stat-total">0</div>
                  <div class="integrations-hero-stat-lbl">Services</div>
                </div>
              </div>
              <div class="integrations-hero-stat k-row k-spring">
                <span class="ms integrations-hero-stat-icon">power</span>
                <div>
                  <div class="integrations-hero-stat-val" id="integrations-stat-connected">0</div>
                  <div class="integrations-hero-stat-lbl">Connected</div>
                </div>
              </div>
              <div class="integrations-hero-stat k-row k-spring">
                <span class="ms integrations-hero-stat-icon">build</span>
                <div>
                  <div class="integrations-hero-stat-val" id="integrations-stat-tools">0</div>
                  <div class="integrations-hero-stat-lbl">Tools</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Two-column body -->
          <div class="integrations-body">
            <!-- Main column: tabs + content -->
            <div class="integrations-main-col">
              <div class="integrations-content" id="integrations-content">
                <!-- Rendered by integrations/molecules.ts -->
              </div>
            </div>

            <!-- Side panel: status + quick actions -->
            <div class="integrations-side-panel k-stagger">
              <!-- Connection Health card -->
              <div class="integrations-panel-card k-row k-spring k-materialise">
                <div class="integrations-panel-card-header">
                  <span class="ms integrations-panel-card-icon">monitor_heart</span>
                  <span class="integrations-panel-card-title">Connection Health</span>
                </div>
                <div class="integrations-health-list" id="integrations-health-list">
                  <div class="integrations-health-empty">No connections yet</div>
                </div>
              </div>

              <!-- Category Breakdown card -->
              <div class="integrations-panel-card k-row k-spring k-materialise">
                <div class="integrations-panel-card-header">
                  <span class="ms integrations-panel-card-icon">donut_small</span>
                  <span class="integrations-panel-card-title">By Category</span>
                </div>
                <div class="integrations-category-breakdown" id="integrations-category-breakdown">
                  <!-- filled by JS -->
                </div>
              </div>

              <!-- Quick Actions card -->
              <div class="integrations-panel-card k-row k-spring k-materialise">
                <div class="integrations-panel-card-header">
                  <span class="ms integrations-panel-card-icon">rocket_launch</span>
                  <span class="integrations-panel-card-title">Quick Actions</span>
                </div>
                <div class="integrations-quick-actions">
                  <button class="integrations-quick-btn" id="integrations-qa-browse">
                    <span class="ms">search</span> Browse All
                  </button>
                  <button class="integrations-quick-btn" id="integrations-qa-automations">
                    <span class="ms">auto_fix_high</span> Automations
                  </button>
                  <button class="integrations-quick-btn" id="integrations-qa-queries">
                    <span class="ms">psychology</span> Agent Queries
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Today View ═══ -->
        <div class="view today-view" id="today-view">
          <div class="today-content" id="today-content">
            <!-- Rendered by today.ts -->
          </div>
        </div>

        <!-- ═══ Agents View ═══ -->
        <div class="view agents-view" id="agents-view">
          <!-- Hero header -->
          <div class="agents-hero">
            <div class="agents-hero-left">
              <h1 class="agents-hero-title">Fleet Command</h1>
              <p class="agents-hero-sub">Manage your AI agents, deploy templates, and monitor fleet activity</p>
            </div>
            <div class="agents-hero-right">
              <div class="agents-hero-stat k-row k-spring">
                <span class="ms agents-hero-stat-icon">smart_toy</span>
                <div>
                  <div class="agents-hero-stat-val" id="agents-stat-total">0</div>
                  <div class="agents-hero-stat-lbl">Agents</div>
                </div>
              </div>
              <div class="agents-hero-stat k-row k-spring">
                <span class="ms agents-hero-stat-icon">radio_button_checked</span>
                <div>
                  <div class="agents-hero-stat-val" id="agents-stat-active">0</div>
                  <div class="agents-hero-stat-lbl">Active</div>
                </div>
              </div>
              <div class="agents-hero-stat k-row k-spring">
                <span class="ms agents-hero-stat-icon">model_training</span>
                <div>
                  <div class="agents-hero-stat-val" id="agents-stat-models">0</div>
                  <div class="agents-hero-stat-lbl">Models</div>
                </div>
              </div>
              <button class="btn btn-primary" id="agents-create-btn">
                <span class="ms ms-sm">add</span>
                New Agent
              </button>
            </div>
          </div>

          <!-- Two-column body -->
          <div class="agents-body">
            <!-- Main column: fleet roster/grid -->
            <div class="agents-main-col">
              <!-- Fleet section -->
              <div class="agents-section k-row k-materialise">
                <div class="agents-section-header">
                  <span class="ms agents-section-icon">groups</span>
                  <span class="agents-section-title">Your Fleet</span>
                  <div class="agents-toggle-btns" id="agents-toggle-btns">
                    <!-- filled by JS -->
                  </div>
                </div>
                <div class="agents-grid" id="agents-grid">
                  <!-- Agent cards render here -->
                </div>
              </div>

              <!-- Templates marketplace section -->
              <div class="agents-section k-row k-materialise">
                <div class="agents-section-header">
                  <span class="ms agents-section-icon">store</span>
                  <span class="agents-section-title">Agent Templates</span>
                  <span class="agents-section-badge">Install &amp; Go</span>
                </div>
                <p class="agents-section-desc">Pre-configured agent blueprints — one click to deploy</p>
                <div class="agents-templates-grid" id="agents-templates-grid">
                  <!-- filled by JS -->
                </div>
              </div>
            </div>

            <!-- Side panel: quick info -->
            <div class="agents-side-panel k-stagger">
              <!-- Capabilities card -->
              <div class="agents-panel-card k-row k-spring k-materialise">
                <div class="agents-panel-card-header">
                  <span class="ms agents-panel-card-icon">bolt</span>
                  <span class="agents-panel-card-title">Capabilities</span>
                </div>
                <div class="agents-capabilities-list" id="agents-capabilities-list">
                  <!-- filled by JS -->
                </div>
              </div>

              <!-- Recent Activity card -->
              <div class="agents-panel-card k-row k-spring k-materialise">
                <div class="agents-panel-card-header">
                  <span class="ms agents-panel-card-icon">history</span>
                  <span class="agents-panel-card-title">Recent Activity</span>
                </div>
                <div class="agents-activity-list" id="agents-activity-list">
                  <div class="agents-activity-empty">No activity yet</div>
                </div>
              </div>

              <!-- Quick Actions card -->
              <div class="agents-panel-card k-row k-spring k-materialise">
                <div class="agents-panel-card-header">
                  <span class="ms agents-panel-card-icon">rocket_launch</span>
                  <span class="agents-panel-card-title">Quick Actions</span>
                </div>
                <div class="agents-quick-actions">
                  <button class="agents-quick-btn" id="agents-qa-create">
                    <span class="ms">add_circle</span> New Agent
                  </button>
                  <button class="agents-quick-btn" id="agents-qa-import">
                    <span class="ms">download</span> Import Config
                  </button>
                  <button class="agents-quick-btn" id="agents-qa-export">
                    <span class="ms">upload</span> Export Fleet
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Chat View ═══ -->
        <div class="view chat-view" id="chat-view">
          <!-- Slim header: agent identity + session switcher -->
          <div class="chat-header">
            <div class="chat-header-left">
              <div class="chat-avatar" id="chat-avatar">
                <img
                  src="/src/assets/avatars/5.png"
                  alt=""
                  width="32"
                  height="32"
                  style="border-radius: 50%"
                />
              </div>
              <div>
                <div class="chat-title" id="chat-agent-name">Agent</div>
                <select
                  class="chat-model-select"
                  id="chat-model-select"
                  title="Switch model for this chat"
                >
                  <option value="default">Default Model</option>
                </select>
              </div>
            </div>
            <div class="chat-header-right">
              <select
                class="chat-session-select"
                id="chat-session-select"
                title="Switch session"
              ></select>
              <button class="btn btn-ghost" id="new-chat-btn" title="New Chat">
                <span class="ms">add</span>
              </button>
            </div>
          </div>

          <!-- Mission control body: chat + side panel -->
          <div class="chat-mission-body">
            <!-- ── Main chat column ── -->
            <div class="chat-main-col">
              <!-- Compaction warning banner -->
              <div class="compaction-warning" id="compaction-warning" style="display: none">
                <span class="ms ms-sm">warning</span>
                <span id="compaction-warning-text"
                  >Context window filling up — older messages may be compacted soon</span
                >
                <button class="btn btn-ghost btn-sm" id="compaction-warning-dismiss" title="Dismiss">
                  ×
                </button>
              </div>

              <!-- Session budget alert banner -->
              <div
                class="compaction-warning budget-alert"
                id="session-budget-alert"
                style="display: none"
              >
                <span class="ms ms-sm">attach_money</span>
                <span id="session-budget-alert-text">Approaching budget limit</span>
                <button
                  class="btn btn-ghost btn-sm"
                  onclick="this.parentElement.style.display = 'none'"
                  title="Dismiss"
                >
                  ×
                </button>
              </div>

              <div class="chat-messages" id="chat-messages">
                <div class="empty-state" id="chat-empty">
                  <div class="empty-icon">
                    <span class="ms" style="font-size: 48px">chat</span>
                  </div>
                  <div class="empty-title">Start a conversation</div>
                  <div class="empty-subtitle">Ask anything — your agent is ready</div>
                </div>
              </div>

              <div class="chat-input-container">
                <div
                  class="chat-attachment-preview"
                  id="chat-attachment-preview"
                  style="display: none"
                ></div>
                <div class="chat-input-wrapper">
                  <button
                    class="chat-attach-btn"
                    id="chat-attach-btn"
                    title="Attach file"
                    data-icon="paperclip"
                  ></button>
                  <input
                    type="file"
                    id="chat-file-input"
                    multiple
                    accept="image/jpeg,image/png,image/gif,image/webp,.pdf,.txt,.md,.csv,.json,.xml,.yaml,.yml,.toml,.py,.rs,.js,.ts,.html,.css,.sh,.log,.c,.cpp,.h,.java,.rb,.go,.sql"
                    style="display: none"
                  />
                  <textarea
                    class="chat-input"
                    id="chat-input"
                    placeholder="Message your agent..."
                    rows="1"
                  ></textarea>
                  <button class="chat-talk-btn" id="chat-talk-btn" title="Talk Mode — hold to speak">
                    <span class="ms">mic</span>
                  </button>
                  <button
                    class="chat-send"
                    id="chat-send"
                    title="Send message"
                    data-icon="arrow-up"
                  ></button>
                </div>
                <button class="chat-abort-btn" id="chat-abort-btn" style="display: none">
                  <span data-icon="square"></span>
                  Stop
                </button>
              </div>
            </div>

            <!-- ── Mission side panel ── -->
            <div class="chat-mission-panel k-stagger" id="chat-mission-panel">

              <!-- Context Gauge -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header">
                  <span class="ms mission-card-icon">speed</span>
                  <span class="mission-card-title">CONTEXT WINDOW</span>
                </div>
                <div class="mission-gauge-row">
                  <div class="mission-gauge" id="mission-ctx-gauge">
                    <!-- Filled by chat-mission-panel.ts -->
                  </div>
                  <div class="mission-gauge-stats">
                    <div class="mission-stat">
                      <span class="mission-stat-val" id="mission-ctx-used">0</span>
                      <span class="mission-stat-lbl">used</span>
                    </div>
                    <div class="mission-stat">
                      <span class="mission-stat-val" id="mission-ctx-limit">128k</span>
                      <span class="mission-stat-lbl">limit</span>
                    </div>
                  </div>
                </div>
                <!-- Mini token bar (keeps existing IDs for compatibility) -->
                <div class="token-meter" id="token-meter" title="Session token usage" style="display:none">
                  <div class="token-meter-bar">
                    <div class="token-meter-fill" id="token-meter-fill"></div>
                  </div>
                  <span class="token-meter-label" id="token-meter-label">0 tokens</span>
                </div>
                <!-- Context breakdown popover -->
                <div class="ctx-breakdown-panel" id="context-breakdown-panel" style="display: none">
                  <div class="ctx-breakdown-header">Context Window</div>
                  <div class="ctx-breakdown-summary">0 / 128K tokens &bull; 0%</div>
                  <div class="ctx-breakdown-bar">
                    <div class="ctx-breakdown-fill"></div>
                  </div>
                  <div class="ctx-breakdown-rows"></div>
                  <div class="ctx-breakdown-warn" style="display: none"></div>
                </div>
              </div>

              <!-- Session Metrics -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header">
                  <span class="ms mission-card-icon">monitoring</span>
                  <span class="mission-card-title">SESSION METRICS</span>
                </div>
                <div class="mission-metrics-grid">
                  <div class="mission-metric">
                    <span class="mission-metric-val" id="mission-tokens-in">0</span>
                    <span class="mission-metric-lbl">INPUT</span>
                  </div>
                  <div class="mission-metric">
                    <span class="mission-metric-val" id="mission-tokens-out">0</span>
                    <span class="mission-metric-lbl">OUTPUT</span>
                  </div>
                  <div class="mission-metric">
                    <span class="mission-metric-val" id="mission-cost">$0</span>
                    <span class="mission-metric-lbl">COST</span>
                  </div>
                  <div class="mission-metric">
                    <span class="mission-metric-val" id="mission-msgs">0</span>
                    <span class="mission-metric-lbl">MESSAGES</span>
                  </div>
                </div>
              </div>

              <!-- Active Jobs / Tool Calls -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header">
                  <span class="ms mission-card-icon">engineering</span>
                  <span class="mission-card-title">ACTIVE JOBS</span>
                  <span class="mission-card-badge k-breathe k-status-healthy" id="mission-jobs-badge">
                    <span class="k-indicator"></span>
                    <span id="mission-jobs-count">0</span>
                  </span>
                </div>
                <div class="mission-jobs-list" id="mission-jobs-list">
                  <div class="mission-jobs-empty">
                    <span class="ms" style="font-size:16px;color:var(--text-muted)">hourglass_empty</span>
                    <span>Waiting for activity…</span>
                  </div>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header">
                  <span class="ms mission-card-icon">bolt</span>
                  <span class="mission-card-title">QUICK ACTIONS</span>
                </div>
                <div class="mission-actions-grid">
                  <button class="mission-action-btn" id="session-rename-btn" title="Rename session">
                    <span class="ms">edit</span>
                    <span>Rename</span>
                  </button>
                  <button class="mission-action-btn" id="session-delete-btn" title="Delete session">
                    <span class="ms">delete</span>
                    <span>Delete</span>
                  </button>
                  <button class="mission-action-btn" id="session-clear-btn" title="Clear history">
                    <span class="ms">delete_sweep</span>
                    <span>Clear</span>
                  </button>
                  <button class="mission-action-btn" id="session-compact-btn" title="Compact storage">
                    <span class="ms">compress</span>
                    <span>Compact</span>
                  </button>
                </div>
              </div>

              <!-- Tool Approvals — per-category auto-approve toggles -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header mission-card-header-toggle" data-toggle="mission-approvals-body">
                  <span class="ms mission-card-icon">verified_user</span>
                  <span class="mission-card-title">APPROVALS</span>
                  <span class="ms mission-card-chevron">expand_more</span>
                </div>
                <div class="mission-card-collapsible" id="mission-approvals-body">
                  <div class="mission-approvals-list" id="mission-approvals-list">
                    <!-- Populated by chat-mission-panel.ts -->
                  </div>
                </div>
              </div>

              <!-- Quick Prompts — common asks, one-click to chat -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header mission-card-header-toggle" data-toggle="mission-prompts-body">
                  <span class="ms mission-card-icon">chat_bubble</span>
                  <span class="mission-card-title">QUICK PROMPTS</span>
                  <span class="ms mission-card-chevron">expand_more</span>
                </div>
                <div class="mission-card-collapsible" id="mission-prompts-body">
                  <div class="mission-prompt-pills" id="mission-prompt-pills">
                    <!-- Populated by chat-mission-panel.ts -->
                  </div>
                </div>
              </div>

              <!-- Automations — popular templates, one-click activate -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header mission-card-header-toggle" data-toggle="mission-automations-body">
                  <span class="ms mission-card-icon">bolt</span>
                  <span class="mission-card-title">AUTOMATIONS</span>
                  <span class="mission-card-badge" id="mission-auto-badge">0</span>
                  <span class="ms mission-card-chevron">expand_more</span>
                </div>
                <div class="mission-card-collapsible" id="mission-automations-body">
                  <div class="mission-compact-list" id="mission-automations-list">
                    <!-- Populated by chat-mission-panel.ts -->
                  </div>
                </div>
              </div>

              <!-- Queries — saved questions, one-click to chat -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header mission-card-header-toggle" data-toggle="mission-queries-body">
                  <span class="ms mission-card-icon">search</span>
                  <span class="mission-card-title">QUERIES</span>
                  <span class="ms mission-card-chevron">expand_more</span>
                </div>
                <div class="mission-card-collapsible" id="mission-queries-body">
                  <div class="mission-compact-list" id="mission-queries-list">
                    <!-- Populated by chat-mission-panel.ts -->
                  </div>
                </div>
              </div>

              <!-- Search in conversation -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header">
                  <span class="ms mission-card-icon">search</span>
                  <span class="mission-card-title">SEARCH</span>
                </div>
                <div class="mission-search-conv-wrap">
                  <input type="text" class="mission-search-conv-input" id="mission-search-conv" placeholder="Search messages…" />
                </div>
              </div>

              <!-- Agent Selector -->
              <div class="mission-card k-row k-spring k-materialise">
                <div class="mission-card-header">
                  <span class="ms mission-card-icon">group</span>
                  <span class="mission-card-title">AGENT</span>
                </div>
                <div class="mission-agent-select-wrap">
                  <select class="mission-agent-select" id="chat-agent-select" title="Switch agent">
                    <option value="default">Agent</option>
                  </select>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- ═══ Tasks Hub — Kanban Board ═══ -->
        <div class="view tasks-view" id="tasks-view">
          <!-- Kinetic hero header -->
          <div class="tasks-hero">
            <div class="tasks-hero-left">
              <h1 class="tasks-hero-title">Tasks</h1>
              <p class="tasks-hero-sub">Create, assign, and track work across your AI agent fleet</p>
              <div class="tasks-tabs" id="tasks-tabs">
                <button class="tasks-tab active" data-tasks-tab="board">Board</button>
                <button class="tasks-tab" data-tasks-tab="scheduled">Scheduled</button>
                <button class="tasks-tab" data-tasks-tab="squads">Squads</button>
                <button class="tasks-tab" data-tasks-tab="projects">Projects</button>
              </div>
            </div>
            <div class="tasks-hero-right">
              <div class="tasks-hero-stat k-row k-spring">
                <span class="ms tasks-hero-stat-icon">task_alt</span>
                <div>
                  <div class="tasks-hero-stat-val" id="tasks-stat-total">0</div>
                  <div class="tasks-hero-stat-lbl">Tasks</div>
                </div>
              </div>
              <div class="tasks-hero-stat k-row k-spring">
                <span class="ms tasks-hero-stat-icon">bolt</span>
                <div>
                  <div class="tasks-hero-stat-val" id="tasks-stat-active">0</div>
                  <div class="tasks-hero-stat-lbl">Active</div>
                </div>
              </div>
              <div class="tasks-hero-stat k-row k-spring">
                <span class="ms tasks-hero-stat-icon">schedule</span>
                <div>
                  <div class="tasks-hero-stat-val" id="tasks-stat-cron">0</div>
                  <div class="tasks-hero-stat-lbl">Scheduled</div>
                </div>
              </div>
              <button class="btn btn-primary" id="tasks-add-btn">
                <span class="ms ms-sm">add</span>
                New Task
              </button>
            </div>
          </div>

          <!-- Two-column body -->
          <div class="tasks-body">
            <!-- Main column -->
            <div class="tasks-main-col">

              <!-- Tab: Board (Kanban) -->
              <div class="tasks-tab-panel active" id="tasks-tab-board">
                <div class="tasks-board-inner">
                  <!-- Kanban columns -->
                  <div class="tasks-board" id="tasks-board">
                <div class="tasks-column" data-status="inbox">
                  <div class="tasks-column-header">
                    <span class="tasks-column-icon"><span class="ms ms-sm">inbox</span></span>
                    <span class="tasks-column-title">Inbox</span>
                    <span class="tasks-column-count" id="tasks-count-inbox">0</span>
                    <button class="tasks-column-add" data-status="inbox" title="Add task">+</button>
                  </div>
                  <div class="tasks-column-cards" id="tasks-cards-inbox" data-status="inbox"></div>
                </div>

                <div class="tasks-column" data-status="assigned">
                  <div class="tasks-column-header">
                    <span class="tasks-column-icon"><span class="ms ms-sm">person</span></span>
                    <span class="tasks-column-title">Assigned</span>
                    <span class="tasks-column-count" id="tasks-count-assigned">0</span>
                  </div>
                  <div
                    class="tasks-column-cards"
                    id="tasks-cards-assigned"
                    data-status="assigned"
                  ></div>
                </div>

                <div class="tasks-column" data-status="in_progress">
                  <div class="tasks-column-header">
                    <span class="tasks-column-icon"><span class="ms ms-sm">bolt</span></span>
                    <span class="tasks-column-title">In Progress</span>
                    <span class="tasks-column-count" id="tasks-count-in_progress">0</span>
                  </div>
                  <div
                    class="tasks-column-cards"
                    id="tasks-cards-in_progress"
                    data-status="in_progress"
                  ></div>
                </div>

                <div class="tasks-column" data-status="review">
                  <div class="tasks-column-header">
                    <span class="tasks-column-icon"><span class="ms ms-sm">search</span></span>
                    <span class="tasks-column-title">Review</span>
                    <span class="tasks-column-count" id="tasks-count-review">0</span>
                  </div>
                  <div
                    class="tasks-column-cards"
                    id="tasks-cards-review"
                    data-status="review"
                  ></div>
                </div>

                <div class="tasks-column" data-status="blocked">
                  <div class="tasks-column-header">
                    <span class="tasks-column-icon"><span class="ms ms-sm">block</span></span>
                    <span class="tasks-column-title">Blocked</span>
                    <span class="tasks-column-count" id="tasks-count-blocked">0</span>
                  </div>
                  <div
                    class="tasks-column-cards"
                    id="tasks-cards-blocked"
                    data-status="blocked"
                  ></div>
                </div>

                <div class="tasks-column tasks-column-done" data-status="done">
                  <div class="tasks-column-header">
                    <span class="tasks-column-icon"
                      ><span class="ms ms-sm">check_circle</span></span
                    >
                    <span class="tasks-column-title">Done</span>
                    <span class="tasks-column-count" id="tasks-count-done">0</span>
                  </div>
                  <div class="tasks-column-cards" id="tasks-cards-done" data-status="done"></div>
                </div>
              </div>

              <!-- Live feed sidebar -->
              <div class="tasks-feed" id="tasks-feed">
                <div class="tasks-feed-header">
                  <span class="tasks-feed-title">Live Feed</span>
                  <div class="tasks-feed-tabs">
                    <button class="tasks-feed-tab active" data-feed="all">All</button>
                    <button class="tasks-feed-tab" data-feed="tasks">Tasks</button>
                    <button class="tasks-feed-tab" data-feed="status">Status</button>
                  </div>
                </div>
                <div class="tasks-feed-list" id="tasks-feed-list">
                  <div class="tasks-feed-empty">No activity yet</div>
                </div>
              </div>
            </div>
            <!-- /tasks-board-inner -->

            <!-- Empty state (shown when zero tasks) -->
            <div class="empty-state" id="tasks-empty" style="display: none">
              <div class="empty-icon"><span class="ms" style="font-size: 48px">task_alt</span></div>
              <div class="empty-title">Your task board is empty</div>
              <div class="empty-subtitle">
                Create tasks and assign them to your AI agents. They'll move through columns as agents work on them.
              </div>
              <div class="empty-actions">
                <button class="btn btn-primary" id="tasks-empty-create">
                  <span class="ms ms-sm">add</span> Create First Task
                </button>
              </div>
            </div>
          </div>
          <!-- /tasks-tab-board -->

          <!-- Tab: Scheduled (Automations) -->
          <div class="tasks-tab-panel" id="tasks-tab-scheduled" style="display: none">
            <div class="tasks-scheduled-header">
              <span class="cron-service-status" id="cron-service-status" title="Cron service status"></span>
              <button class="btn btn-primary btn-sm" id="add-cron-btn">
                <span class="ms ms-sm">add</span> New Automation
              </button>
              <button class="btn btn-ghost btn-sm" id="add-morning-brief-btn" title="Quick-add a Morning Brief automation">
                <span class="ms ms-sm">wb_sunny</span> Morning Brief
              </button>
            </div>
            <div class="auto-board">
              <div class="auto-column">
                <div class="auto-column-header">
                  <span class="auto-column-dot active"></span>
                  <span>Active</span>
                  <span class="auto-column-count" id="cron-active-count">0</span>
                </div>
                <div class="auto-column-cards" id="cron-active-cards"></div>
              </div>
              <div class="auto-column">
                <div class="auto-column-header">
                  <span class="auto-column-dot paused"></span>
                  <span>Paused</span>
                  <span class="auto-column-count" id="cron-paused-count">0</span>
                </div>
                <div class="auto-column-cards" id="cron-paused-cards"></div>
              </div>
              <div class="auto-column">
                <div class="auto-column-header">
                  <span class="auto-column-dot history"></span>
                  <span>Run History</span>
                </div>
                <div class="auto-column-cards" id="cron-history-cards"></div>
              </div>
            </div>
            <div class="empty-state" id="cron-empty">
              <div class="empty-icon"><span class="ms" style="font-size: 48px">bolt</span></div>
              <div class="empty-title">No automations yet</div>
              <div class="empty-subtitle">Create scheduled tasks, triggers, and recurring workflows</div>
              <div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;justify-content:center">
                <button class="btn btn-primary" id="cron-empty-add">Create Automation</button>
                <button class="btn btn-ghost" id="cron-empty-morning-brief">
                  <span class="ms">wb_sunny</span> Morning Brief Template
                </button>
              </div>
            </div>
            <div class="view-loading" id="cron-loading" style="display: none">Loading automations…</div>
            <!-- Add/Edit Automation Modal -->
            <div class="modal-overlay" id="cron-modal" style="display: none">
              <div class="modal-card">
                <div class="modal-header">
                  <h2 class="modal-title" id="cron-modal-title">New Automation</h2>
                  <button class="btn-icon" id="cron-modal-close">✕</button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="cron-form-label" placeholder="My automation" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Schedule</label>
                    <select class="form-input" id="cron-form-schedule-preset">
                      <option value="">Custom schedule...</option>
                      <option value="every 5m">Every 5 minutes</option>
                      <option value="every 15m">Every 15 minutes</option>
                      <option value="every 30m">Every 30 minutes</option>
                      <option value="every 1h">Every hour</option>
                      <option value="every 6h">Every 6 hours</option>
                      <option value="daily 09:00">Daily at 9 AM</option>
                      <option value="daily 12:00">Daily at noon</option>
                      <option value="daily 18:00">Daily at 6 PM</option>
                    </select>
                    <input type="text" class="form-input" id="cron-form-schedule" placeholder="every 5m, every 1h, daily 09:00" style="margin-top: 8px" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Task prompt</label>
                    <textarea class="form-input" id="cron-form-prompt" rows="3" placeholder="What should the agent do?"></textarea>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Agent ID <span style="color: var(--text-muted); font-weight: normal">(optional)</span></label>
                    <input type="text" class="form-input" id="cron-form-agent" placeholder="default" />
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" id="cron-modal-cancel">Cancel</button>
                  <button class="btn btn-primary" id="cron-modal-save">Create</button>
                </div>
              </div>
            </div>
          </div>
          <!-- /tasks-tab-scheduled -->

          <!-- Tab: Projects (Orchestrator) -->
          <div class="tasks-tab-panel" id="tasks-tab-projects" style="display: none">
            <div class="orchestrator-content">
              <div class="orch-project-list" id="orch-project-list">
                <div class="empty-state">
                  <span class="ms" style="font-size: 48px">account_tree</span>
                  <h3>No projects yet</h3>
                  <p>Create a project to orchestrate multiple agents working together on a shared goal.</p>
                  <button class="btn btn-primary" id="orch-create-btn" style="margin-top: 12px">
                    <span class="ms ms-sm">add</span> New Project
                  </button>
                </div>
              </div>

              <div class="orch-project-detail" id="orch-project-detail" style="display: none">
                <div class="orch-detail-header">
                  <button class="btn btn-ghost btn-sm" id="orch-back-btn">← Back</button>
                  <div class="orch-detail-title">
                    <h2 id="orch-detail-name">Project Name</h2>
                    <span class="orch-status-badge" id="orch-detail-status">planning</span>
                  </div>
                  <div class="orch-detail-actions">
                    <button class="btn btn-primary btn-sm" id="orch-run-btn">▶ Run</button>
                    <button class="btn btn-ghost btn-sm" id="orch-edit-btn">Edit</button>
                    <button class="btn btn-danger btn-sm" id="orch-delete-btn">Delete</button>
                  </div>
                </div>
                <div class="orch-detail-goal" id="orch-detail-goal"></div>

                <div class="orch-section">
                  <div class="orch-section-header">
                    <h3>Agent Team</h3>
                    <button class="btn btn-ghost btn-sm" id="orch-add-agent-btn">+ Add Agent</button>
                  </div>
                  <div class="orch-agent-roster" id="orch-agent-roster"></div>
                </div>

                <div class="orch-section">
                  <h3>Message Bus</h3>
                  <div class="orch-message-bus" id="orch-message-bus">
                    <div class="empty-state-sm">No messages yet. Run the project to see agent communication.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Create/Edit Project Modal -->
            <div class="modal-overlay" id="orch-modal" style="display: none">
              <div class="modal" style="max-width: 560px">
                <div class="modal-header">
                  <h3 id="orch-modal-title">New Project</h3>
                  <button class="modal-close" id="orch-modal-close">×</button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label>Project Title</label>
                    <input type="text" class="form-input" id="orch-form-title" placeholder="e.g. Build Landing Page" />
                  </div>
                  <div class="form-group">
                    <label>Goal</label>
                    <textarea class="form-input" id="orch-form-goal" rows="4" placeholder="Describe what this project should achieve..."></textarea>
                  </div>
                  <div class="form-group">
                    <label>Boss Agent ID</label>
                    <input type="text" class="form-input" id="orch-form-boss" placeholder="default" value="default" />
                    <small class="form-hint">The agent that orchestrates the project. Must have a soul file in the Foundry.</small>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-ghost" id="orch-modal-cancel">Cancel</button>
                  <button class="btn btn-primary" id="orch-modal-save">Create Project</button>
                </div>
              </div>
            </div>

            <!-- Add Agent Modal -->
            <div class="modal-overlay" id="orch-agent-modal" style="display: none">
              <div class="modal" style="max-width: 480px">
                <div class="modal-header">
                  <h3>Add Agent to Project</h3>
                  <button class="modal-close" id="orch-agent-modal-close">×</button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label>Agent ID</label>
                    <input type="text" class="form-input" id="orch-agent-form-id" placeholder="e.g. coder-1" />
                  </div>
                  <div class="form-group">
                    <label>Specialty</label>
                    <select class="form-input" id="orch-agent-form-specialty">
                      <option value="general">General</option>
                      <option value="coder">Coder</option>
                      <option value="researcher">Researcher</option>
                      <option value="designer">Designer</option>
                      <option value="communicator">Communicator</option>
                      <option value="security">Security</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Model <span style="font-weight:normal;color:var(--text-muted)">(optional — uses routing config if blank)</span></label>
                    <select class="form-input" id="orch-agent-form-model">
                      <option value="">(use routing default)</option>
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-ghost" id="orch-agent-modal-cancel">Cancel</button>
                  <button class="btn btn-primary" id="orch-agent-modal-save">Add Agent</button>
                </div>
              </div>
            </div>
          </div>
          <!-- /tasks-tab-projects -->

          <!-- Tab: Squads (Agent Teams) -->
          <div class="tasks-tab-panel" id="tasks-tab-squads" style="display: none">
            <div id="tasks-squads-container"></div>
          </div>
          <!-- /tasks-tab-squads -->

            </div>
            <!-- /tasks-main-col -->

            <!-- Side panel -->
            <div class="tasks-side-panel k-stagger">
              <!-- What Is Tasks? -->
              <div class="tasks-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">info</span>
                  <span class="skills-panel-card-title">Task Engine</span>
                </div>
                <div class="skills-panel-card-body">
                  <p>Create tasks and assign them to AI agents. Agents pick up work, move cards through columns, and report back in the live feed.</p>
                  <p>Supports <strong>drag-and-drop</strong> Kanban, <strong>multi-agent</strong> assignment, and <strong>model overrides</strong> per task.</p>
                </div>
              </div>

              <!-- Automations -->
              <div class="tasks-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">schedule</span>
                  <span class="skills-panel-card-title">Automations</span>
                </div>
                <div class="skills-panel-card-body">
                  <ul class="skills-explainer-list">
                    <li><span class="ms">sync</span> Cron-based recurring task schedules</li>
                    <li><span class="ms">wb_sunny</span> Morning Brief template for daily digests</li>
                    <li><span class="ms">bolt</span> Auto-run agents on schedule triggers</li>
                    <li><span class="ms">history</span> Full run history with duration tracking</li>
                  </ul>
                </div>
              </div>

              <!-- Projects -->
              <div class="tasks-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">account_tree</span>
                  <span class="skills-panel-card-title">Projects</span>
                </div>
                <div class="skills-panel-card-body">
                  <p>Orchestrate multiple agents working together on a shared goal. Assign a boss agent, add specialists, and watch them coordinate via the message bus.</p>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="tasks-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">rocket_launch</span>
                  <span class="skills-panel-card-title">Quick Actions</span>
                </div>
                <div class="skills-quick-actions">
                  <button class="skills-quick-btn" id="tasks-qa-new-task">
                    <span class="ms">add</span> New Task
                  </button>
                  <button class="skills-quick-btn" id="tasks-qa-new-automation">
                    <span class="ms">schedule</span> New Automation
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- /tasks-body -->

          <!-- Task detail modal (hidden by default) -->
          <div class="tasks-modal-overlay" id="tasks-detail-modal" style="display: none">
            <div class="tasks-modal">
              <div class="tasks-modal-header">
                <h2 class="tasks-modal-title" id="tasks-modal-title">Task</h2>
                <button class="btn-icon" id="tasks-modal-close">✕</button>
              </div>
              <div class="tasks-modal-body">
                <div class="tasks-modal-field">
                  <label>Title</label>
                  <input type="text" id="tasks-modal-input-title" class="input" placeholder="Task title" />
                </div>
                <div class="tasks-modal-field">
                  <label>Description</label>
                  <textarea id="tasks-modal-input-desc" class="input" rows="4" placeholder="Describe what needs to be done..."></textarea>
                </div>
                <div class="tasks-modal-row">
                  <div class="tasks-modal-field">
                    <label>Priority</label>
                    <select id="tasks-modal-input-priority" class="input">
                      <option value="low">Low</option>
                      <option value="medium" selected>Medium</option>
                      <option value="high">High</option>
                      <option value="urgent">Urgent</option>
                    </select>
                  </div>
                  <div class="tasks-modal-field">
                    <label>Assign Agents</label>
                    <div id="tasks-modal-agents-tags" class="agent-tags-container"></div>
                    <select id="tasks-modal-input-agent" class="input" style="margin-top: 6px">
                      <option value="">+ Add agent</option>
                    </select>
                    <div class="tasks-modal-hint">Click tag to toggle lead ★ / collaborator. First agent is lead by default.</div>
                  </div>
                </div>
                <div class="tasks-modal-field">
                  <label>Schedule (Cron)</label>
                  <div class="tasks-modal-cron-row">
                    <input type="text" id="tasks-modal-input-cron" class="input" placeholder="e.g. every 1h, daily 09:00" />
                    <label class="tasks-modal-cron-toggle">
                      <input type="checkbox" id="tasks-modal-input-cron-enabled" />
                      <span>Enabled</span>
                    </label>
                  </div>
                </div>
                <div class="tasks-modal-field">
                  <label>Model Override</label>
                  <select id="tasks-modal-input-model" class="input" style="max-width: 320px">
                    <option value="">(use default)</option>
                  </select>
                  <div class="tasks-modal-hint">Leave empty to use the agent's default model. Select a model to override for this task only.</div>
                </div>
                <div class="tasks-modal-field" id="tasks-modal-activity-section" style="display: none">
                  <label>Activity</label>
                  <div class="tasks-modal-activity" id="tasks-modal-activity"></div>
                </div>
              </div>
              <div class="tasks-modal-footer">
                <button class="btn btn-ghost btn-sm" id="tasks-modal-delete" style="display: none">Delete</button>
                <div style="flex: 1"></div>
                <button class="btn btn-ghost btn-sm" id="tasks-modal-run" style="display: none" title="Send task to agent now">
                  <span class="ms ms-sm">play_arrow</span> Run Now
                </button>
                <button class="btn btn-primary btn-sm" id="tasks-modal-save">Save</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Squads View — Agent Teams ═══ -->
        <div class="view squads-layout" id="squads-view">
          <div class="squads-sidebar">
            <div class="squads-sidebar-header">
              <span class="squads-sidebar-title">Squads</span>
              <button class="btn btn-primary btn-sm" id="squads-create-btn">
                <span class="ms ms-sm">add</span>
                New
              </button>
            </div>
            <div class="squads-list" id="squads-list"></div>
          </div>
          <div class="squads-main">
            <div class="empty-state" id="squads-empty" style="display: flex">
              <div class="empty-icon">
                <span class="ms" style="font-size: 48px">groups</span>
              </div>
              <div class="empty-title">No squads yet</div>
              <div class="empty-subtitle">
                Create a squad to coordinate teams of agents on a shared goal
              </div>
              <div class="empty-features">
                <div class="empty-feature-item">
                  <span class="ms ms-sm">check_circle</span> Multi-agent coordination with shared
                  goals
                </div>
                <div class="empty-feature-item">
                  <span class="ms ms-sm">check_circle</span> Broadcast messages between squad
                  members
                </div>
                <div class="empty-feature-item">
                  <span class="ms ms-sm">check_circle</span> Real-time activity feed per squad
                </div>
              </div>
              <button class="btn btn-primary" id="squads-empty-create" style="margin-top: 16px">
                Create Squad
              </button>
              <div class="empty-hint">
                You'll need at least 2 agents configured to create a squad
              </div>
            </div>
            <div id="squads-detail" style="display: none"></div>
          </div>

          <!-- Create/Edit Squad Modal -->
          <div class="modal-overlay" id="squad-modal" style="display: none">
            <div class="modal" style="max-width: 480px">
              <div class="modal-header">
                <h3 id="squad-modal-title">New Squad</h3>
                <button class="modal-close" id="squad-modal-close">×</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label>Squad Name</label>
                  <input
                    type="text"
                    class="form-input"
                    id="squad-form-name"
                    placeholder="e.g. Research Team"
                  />
                </div>
                <div class="form-group">
                  <label>Goal</label>
                  <textarea
                    class="form-input"
                    id="squad-form-goal"
                    rows="3"
                    placeholder="What should this squad accomplish?"
                  ></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-ghost" id="squad-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="squad-modal-save">Create</button>
              </div>
            </div>
          </div>

          <!-- Add Member Modal -->
          <div class="modal-overlay" id="squad-member-modal" style="display: none">
            <div class="modal" style="max-width: 400px">
              <div class="modal-header">
                <h3>Add Member</h3>
                <button class="modal-close" id="squad-member-close">×</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label>Agent</label>
                  <select class="form-input" id="squad-member-agent">
                    <option value="">Select agent...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Role</label>
                  <select class="form-input" id="squad-member-role">
                    <option value="member">Member</option>
                    <option value="coordinator">Coordinator</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-ghost" id="squad-member-cancel">Cancel</button>
                <button class="btn btn-primary" id="squad-member-save">Add</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Projects View — Local File Browser ═══ -->
        <div class="view projects-view" id="code-view">
          <div class="view-header">
            <h1 class="view-title">Projects</h1>
            <div style="display: flex; gap: 6px">
              <button class="btn btn-primary btn-sm" id="projects-add-folder">
                <span class="ms ms-sm">add</span>
                Add Folder
              </button>
              <button class="btn btn-ghost btn-sm" id="projects-refresh-btn">
                <span class="ms ms-sm">sync</span>
                Refresh
              </button>
            </div>
          </div>
          <div class="projects-layout">
            <div class="projects-sidebar">
              <div class="projects-sidebar-header">
                <span class="projects-sidebar-title">Folders</span>
              </div>
              <div class="projects-sidebar-list" id="projects-sidebar-list"></div>
            </div>
            <div class="projects-main">
              <div class="projects-file-tree" id="projects-file-tree"></div>
              <div class="projects-file-viewer" id="projects-file-viewer"></div>
              <div class="empty-state" id="projects-empty">
                <div class="empty-icon">
                  <span class="ms" style="font-size: 48px">folder</span>
                </div>
                <div class="empty-title">Your Projects</div>
                <div class="empty-subtitle">
                  Add a local folder to browse files your agent is working on
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Content View — Create Studio ═══ -->
        <div class="view studio-view" id="content-view">
          <div class="studio-sidebar">
            <div class="studio-sidebar-header">
              <span class="studio-sidebar-title">Documents</span>
              <button class="btn-icon" id="content-new-doc" title="New document">
                <span class="ms ms-sm">add</span>
              </button>
            </div>
            <div class="studio-doc-list" id="content-doc-list">
              <div class="studio-doc-empty">No documents yet</div>
            </div>
          </div>
          <div class="studio-main">
            <div class="studio-toolbar" id="content-toolbar" style="display: none">
              <input
                class="studio-title-input"
                id="content-title"
                placeholder="Untitled document"
              />
              <div class="studio-toolbar-actions">
                <select class="studio-type-select" id="content-type">
                  <option value="markdown">Markdown</option>
                  <option value="html">HTML</option>
                  <option value="plaintext">Plain Text</option>
                </select>
                <button class="btn btn-ghost btn-sm" id="content-ai-improve" title="AI improve">
                  <span class="ms ms-sm">auto_awesome</span>
                  AI Improve
                </button>
                <button class="btn btn-primary btn-sm" id="content-save">Save</button>
                <button
                  class="btn btn-ghost btn-sm btn-error"
                  id="content-delete-doc"
                  title="Delete document"
                >
                  Delete
                </button>
              </div>
            </div>
            <div class="studio-editor" id="content-editor-area">
              <div class="empty-state" id="content-empty">
                <div class="empty-icon"><span class="ms" style="font-size: 48px">edit</span></div>
                <div class="empty-title">Content studio</div>
                <div class="empty-subtitle">
                  Create blog posts, marketing copy, documentation — with AI assistance
                </div>
                <div class="empty-features">
                  <div class="empty-feature-item">
                    <span class="ms ms-sm">check_circle</span> AI-powered writing and editing
                  </div>
                  <div class="empty-feature-item">
                    <span class="ms ms-sm">check_circle</span> Blog posts, docs, marketing copy
                  </div>
                  <div class="empty-feature-item">
                    <span class="ms ms-sm">check_circle</span> Schedule automated content generation
                  </div>
                </div>
                <button class="btn btn-primary" id="content-create-first" style="margin-top: 16px">
                  Create Document
                </button>
                <div class="empty-hint">
                  Configure an AI provider in Settings for AI-assisted writing
                </div>
              </div>
              <textarea
                class="studio-content-editor"
                id="content-body"
                style="display: none"
                placeholder="Start writing..."
              ></textarea>
            </div>
            <div class="studio-word-count" id="content-word-count" style="display: none">
              0 words
            </div>
            <!-- Content scheduled tasks -->
            <div
              class="space-cron-widget space-cron-widget-inline"
              id="content-cron-widget"
              style="display: none"
            >
              <div class="space-cron-header">
                <span class="ms ms-sm">bolt</span>
                <span>Publishing schedule</span>
                <span class="space-cron-count" id="content-cron-count">0</span>
              </div>
              <div class="space-cron-items" id="content-cron-items"></div>
            </div>
          </div>
        </div>

        <!-- ═══ Mail View — Email Client ═══ -->
        <div class="view mail-client-view" id="mail-view">
          <!-- Hero header -->
          <div class="mail-hero">
            <div class="mail-hero-left">
              <h1 class="mail-hero-title">Mail</h1>
              <p class="mail-hero-sub">Read, draft, and send emails with AI assistance across all your accounts</p>
            </div>
            <div class="mail-hero-right">
              <div class="mail-hero-stat k-row k-spring">
                <span class="ms mail-hero-stat-icon">mail</span>
                <div>
                  <div class="mail-hero-stat-val" id="mail-stat-accounts">0</div>
                  <div class="mail-hero-stat-lbl">Accounts</div>
                </div>
              </div>
              <div class="mail-hero-stat k-row k-spring">
                <span class="ms mail-hero-stat-icon">inbox</span>
                <div>
                  <div class="mail-hero-stat-val" id="mail-stat-inbox">0</div>
                  <div class="mail-hero-stat-lbl">Inbox</div>
                </div>
              </div>
              <div class="mail-hero-stat k-row k-spring">
                <span class="ms mail-hero-stat-icon">layers</span>
                <div>
                  <div class="mail-hero-stat-val" id="mail-stat-drafts">0</div>
                  <div class="mail-hero-stat-lbl">Drafts</div>
                </div>
              </div>
              <button class="btn btn-primary" id="mail-compose">
                <span class="ms ms-sm">edit</span>
                Compose
              </button>
            </div>
          </div>

          <!-- Two-column body -->
          <div class="mail-body">
            <!-- Main column: 3-pane email client -->
            <div class="mail-main-col">
              <div class="mail-panes">
                <!-- Folder sidebar -->
                <div class="mail-sidebar">
                  <div class="mail-folders">
                    <div class="mail-folder active" data-folder="inbox">
                      <span class="ms ms-sm">inbox</span>
                      <span>Inbox</span>
                      <span class="mail-count" id="mail-inbox-count">0</span>
                    </div>
                    <div class="mail-folder" data-folder="drafts">
                      <span class="ms ms-sm">description</span>
                      <span>Drafts</span>
                    </div>
                    <div class="mail-folder" data-folder="sent">
                      <span class="ms ms-sm">send</span>
                      <span>Sent</span>
                    </div>
                    <div class="mail-folder" data-folder="agent">
                      <span class="ms ms-sm">layers</span>
                      <span>Agent Drafts</span>
                      <span class="mail-count mail-count-accent" id="mail-agent-count">0</span>
                    </div>
                  </div>
                  <div class="mail-accounts-section">
                    <div class="mail-accounts-header">
                      <span class="ms ms-sm">lock</span>
                      Credential Vault
                    </div>
                    <div id="mail-accounts-list">
                      <div class="mail-no-accounts">No accounts connected</div>
                    </div>
                    <button
                      class="btn btn-ghost btn-sm"
                      id="mail-add-account"
                      style="width: 100%; margin-top: 8px"
                    >
                      <span class="ms ms-sm">add</span>
                      Add Account
                    </button>
                  </div>
                  <!-- Mail scheduled tasks -->
                  <div
                    class="space-cron-widget space-cron-widget-sidebar"
                    id="mail-cron-widget"
                    style="display: none"
                  >
                    <div class="space-cron-header">
                      <span class="ms ms-sm">bolt</span>
                      <span>Digests</span>
                      <span class="space-cron-count" id="mail-cron-count">0</span>
                    </div>
                    <div class="space-cron-items" id="mail-cron-items"></div>
                  </div>
                </div>

                <!-- Message list -->
                <div class="mail-list" id="mail-message-list">
                  <div class="mail-list-header">
                    <span class="mail-list-title" id="mail-folder-title">Inbox</span>
                    <button class="btn btn-ghost btn-sm" id="mail-refresh">
                      <span class="ms ms-sm">sync</span>
                    </button>
                  </div>
                  <div class="mail-items" id="mail-items"></div>
                  <div class="empty-state" id="mail-empty">
                    <div class="empty-icon"><span class="ms" style="font-size: 48px">mail</span></div>
                    <div class="empty-title">Connect your email</div>
                    <div class="empty-subtitle">
                      Add an IMAP/SMTP account to read, draft, and send emails with AI assistance
                    </div>
                    <button class="btn btn-primary" id="mail-setup-account" style="margin-top: 16px">
                      Add Email Account
                    </button>
                  </div>
                </div>

                <!-- Preview panel -->
                <div class="mail-preview" id="mail-preview">
                  <div class="mail-preview-empty">Select an email to read</div>
                </div>
              </div>
            </div>

            <!-- Side panel -->
            <div class="mail-side-panel k-stagger">
              <!-- What Is Mail? -->
              <div class="mail-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">info</span>
                  <span class="skills-panel-card-title">AI-Powered Mail</span>
                </div>
                <div class="skills-panel-card-body">
                  <p>Connect your email accounts and let your agent read, draft, and manage messages. Agents can summarise threads, draft replies, and flag important items.</p>
                  <p>Supports <strong>Google OAuth</strong>, <strong>IMAP/SMTP</strong>, and <strong>Himalaya CLI</strong> backends.</p>
                </div>
              </div>

              <!-- Security -->
              <div class="mail-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">shield</span>
                  <span class="skills-panel-card-title">Credential Vault</span>
                </div>
                <div class="skills-panel-card-body">
                  <ul class="skills-explainer-list">
                    <li><span class="ms">lock</span> Credentials stored locally in encrypted vault</li>
                    <li><span class="ms">verified_user</span> Per-account permission controls (read, send, delete)</li>
                    <li><span class="ms">history</span> Full audit log of credential access</li>
                    <li><span class="ms">gpp_maybe</span> Agent needs explicit permission before sending</li>
                  </ul>
                </div>
              </div>

              <!-- Agent Drafts -->
              <div class="mail-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">smart_toy</span>
                  <span class="skills-panel-card-title">Agent Drafts</span>
                </div>
                <div class="skills-panel-card-body">
                  <p>When your agent writes an email, it goes to <strong>Agent Drafts</strong> first. Review, edit, and approve before anything gets sent.</p>
                  <p>Use digests to schedule automated email summaries.</p>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="mail-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">rocket_launch</span>
                  <span class="skills-panel-card-title">Quick Actions</span>
                </div>
                <div class="skills-quick-actions">
                  <button class="skills-quick-btn" id="mail-qa-add-account">
                    <span class="ms">add</span> Add Account
                  </button>
                  <button class="skills-quick-btn" id="mail-qa-refresh">
                    <span class="ms">sync</span> Refresh Inbox
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Channels View — Remote Agent Communication ═══ -->
        <div class="view channels-view" id="channels-view">
          <!-- Hero header -->
          <div class="channels-hero">
            <div class="channels-hero-left">
              <h1 class="channels-hero-title">Command Channels</h1>
              <p class="channels-hero-sub">Talk to your agent from anywhere — Telegram, Discord, Slack, or any platform. No computer needed.</p>
            </div>
            <div class="channels-hero-right">
              <div class="channels-hero-stat k-row k-spring">
                <span class="ms channels-hero-stat-icon">cell_tower</span>
                <div>
                  <div class="channels-hero-stat-val" id="channels-stat-total">0</div>
                  <div class="channels-hero-stat-lbl">Channels</div>
                </div>
              </div>
              <div class="channels-hero-stat k-row k-spring">
                <span class="ms channels-hero-stat-icon">radio_button_checked</span>
                <div>
                  <div class="channels-hero-stat-val" id="channels-stat-active">0</div>
                  <div class="channels-hero-stat-lbl">Active</div>
                </div>
              </div>
              <div class="channels-hero-stat k-row k-spring">
                <span class="ms channels-hero-stat-icon">forum</span>
                <div>
                  <div class="channels-hero-stat-val" id="channels-stat-messages">0</div>
                  <div class="channels-hero-stat-lbl">Messages</div>
                </div>
              </div>
              <button class="btn btn-primary" id="add-channel-btn">
                <span class="ms ms-sm">add</span>
                Add Channel
              </button>
            </div>
          </div>

          <!-- Two-column body -->
          <div class="channels-body">
            <!-- Main column -->
            <div class="channels-main-col">
              <!-- Connected Channels section -->
              <div class="channels-section k-row k-materialise" id="channels-connected-section">
                <div class="channels-section-header">
                  <span class="ms channels-section-icon">link</span>
                  <span class="channels-section-title">Connected Channels</span>
                  <button class="btn btn-ghost btn-sm" id="refresh-channels-btn">
                    <span class="ms ms-sm">sync</span> Refresh
                  </button>
                </div>
                <div class="channel-grid" id="channels-list"></div>
                <div class="channels-empty-inline" id="channels-empty" style="display: none;">
                  <span class="ms" style="font-size: 32px; color: var(--text-muted)">cell_tower</span>
                  <p>No channels connected yet. Add one below or from the side panel.</p>
                </div>
                <div class="view-loading" id="channels-loading" style="display: none">Loading channels…</div>
              </div>

              <!-- Available Platforms section -->
              <div class="channels-section k-row k-materialise">
                <div class="channels-section-header">
                  <span class="ms channels-section-icon">apps</span>
                  <span class="channels-section-title">Available Platforms</span>
                  <span class="channels-section-badge">11 Platforms</span>
                </div>
                <p class="channels-section-desc">Connect your agent to any messaging platform — one click to set up</p>
                <div class="channel-picker-grid" id="channels-picker-empty">
                  <button class="channel-pick-btn" data-ch-type="telegram">
                    <span class="channel-pick-icon telegram">TG</span>
                    <span class="channel-pick-name">Telegram</span>
                    <span class="channel-pick-desc">Message your agent from Telegram via bot API</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="discord">
                    <span class="channel-pick-icon discord">DC</span>
                    <span class="channel-pick-name">Discord</span>
                    <span class="channel-pick-desc">Agent joins servers, responds to DMs &amp; @mentions</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="slack">
                    <span class="channel-pick-icon slack">SL</span>
                    <span class="channel-pick-name">Slack</span>
                    <span class="channel-pick-desc">Socket Mode — DMs and channel mentions</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="whatsapp">
                    <span class="channel-pick-icon whatsapp">WA</span>
                    <span class="channel-pick-name">WhatsApp</span>
                    <span class="channel-pick-desc">Give your agent a phone number people can text</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="matrix">
                    <span class="channel-pick-icon matrix">MX</span>
                    <span class="channel-pick-name">Matrix</span>
                    <span class="channel-pick-desc">Federated chat — any homeserver (Element, etc.)</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="irc">
                    <span class="channel-pick-icon irc">IRC</span>
                    <span class="channel-pick-name">IRC</span>
                    <span class="channel-pick-desc">Classic text protocol — connect to any server</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="mattermost">
                    <span class="channel-pick-icon mattermost">MM</span>
                    <span class="channel-pick-name">Mattermost</span>
                    <span class="channel-pick-desc">Self-hosted team chat via WebSocket + REST</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="nextcloud">
                    <span class="channel-pick-icon nextcloud">NC</span>
                    <span class="channel-pick-name">Nextcloud Talk</span>
                    <span class="channel-pick-desc">Chat with your agent through Nextcloud</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="nostr">
                    <span class="channel-pick-icon nostr">NS</span>
                    <span class="channel-pick-name">Nostr</span>
                    <span class="channel-pick-desc">Decentralized social — responds to mentions on relays</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="twitch">
                    <span class="channel-pick-icon twitch">TW</span>
                    <span class="channel-pick-name">Twitch</span>
                    <span class="channel-pick-desc">Agent joins Twitch chat rooms via IRC</span>
                  </button>
                  <button class="channel-pick-btn" data-ch-type="webchat">
                    <span class="channel-pick-icon default"><span class="ms" style="font-size: 20px">language</span></span>
                    <span class="channel-pick-name">Web Chat</span>
                    <span class="channel-pick-desc">Share a link — anyone chats with your agent in-browser</span>
                  </button>
                </div>
              </div>

              <!-- Direct Send Message section -->
              <div class="channels-section k-row k-materialise" id="channel-send-section" style="display: none;">
                <div class="channels-section-header">
                  <span class="ms channels-section-icon">send</span>
                  <span class="channels-section-title">Send Direct Message</span>
                </div>
                <div class="channels-send-form">
                  <div class="channels-send-field">
                    <label class="channels-send-label">Channel</label>
                    <select id="channel-send-target" class="form-input"></select>
                  </div>
                  <div class="channels-send-field" style="flex: 2">
                    <label class="channels-send-label">Message</label>
                    <input type="text" id="channel-send-message" class="form-input" placeholder="Type a message…" />
                  </div>
                  <button class="btn btn-primary btn-sm" id="channel-send-btn">Send</button>
                </div>
              </div>
            </div>

            <!-- Side panel -->
            <div class="channels-side-panel k-stagger">
              <!-- What Are Channels? card -->
              <div class="channels-panel-card k-row k-spring k-materialise">
                <div class="channels-panel-card-header">
                  <span class="ms channels-panel-card-icon">info</span>
                  <span class="channels-panel-card-title">What Are Channels?</span>
                </div>
                <div class="channels-panel-card-body">
                  <p>Channels let you talk to your AI agent from <strong>anywhere</strong> — your phone, a chat app, or even a web link. No need to be at your computer.</p>
                  <p>Each channel is a bridge between a messaging platform and your agent. Messages you send on Telegram, Discord, or any platform get forwarded to your agent, and it replies right there.</p>
                  <ul class="channels-feature-list">
                    <li><span class="ms">smartphone</span> Message from your phone</li>
                    <li><span class="ms">group</span> Let friends &amp; team chat with your agent</li>
                    <li><span class="ms">shield</span> Access control — approve who can talk</li>
                    <li><span class="ms">sync</span> Always on — agent responds 24/7</li>
                  </ul>
                </div>
              </div>

              <!-- Platform Categories card -->
              <div class="channels-panel-card k-row k-spring k-materialise">
                <div class="channels-panel-card-header">
                  <span class="ms channels-panel-card-icon">category</span>
                  <span class="channels-panel-card-title">Platform Types</span>
                </div>
                <div class="channels-panel-card-body">
                  <div class="channels-category">
                    <div class="channels-category-label">Chat Apps</div>
                    <div class="channels-category-items">Telegram · Discord · Slack · WhatsApp</div>
                  </div>
                  <div class="channels-category">
                    <div class="channels-category-label">Self-Hosted</div>
                    <div class="channels-category-items">Matrix · Mattermost · Nextcloud Talk</div>
                  </div>
                  <div class="channels-category">
                    <div class="channels-category-label">Social &amp; Streaming</div>
                    <div class="channels-category-items">Nostr · Twitch</div>
                  </div>
                  <div class="channels-category">
                    <div class="channels-category-label">Open Protocols</div>
                    <div class="channels-category-items">IRC · Web Chat</div>
                  </div>
                </div>
              </div>

              <!-- Connection Health card -->
              <div class="channels-panel-card k-row k-spring k-materialise">
                <div class="channels-panel-card-header">
                  <span class="ms channels-panel-card-icon">monitor_heart</span>
                  <span class="channels-panel-card-title">Connection Health</span>
                </div>
                <div class="channels-health-list" id="channels-health-list">
                  <div class="channels-health-empty">No active connections</div>
                </div>
              </div>

              <!-- Quick Actions card -->
              <div class="channels-panel-card k-row k-spring k-materialise">
                <div class="channels-panel-card-header">
                  <span class="ms channels-panel-card-icon">rocket_launch</span>
                  <span class="channels-panel-card-title">Quick Actions</span>
                </div>
                <div class="channels-quick-actions">
                  <button class="channels-quick-btn" id="channels-qa-add">
                    <span class="ms">add_circle</span> Add Channel
                  </button>
                  <button class="channels-quick-btn" id="channels-qa-refresh">
                    <span class="ms">sync</span> Refresh All
                  </button>
                  <button class="channels-quick-btn" id="channels-qa-docs">
                    <span class="ms">menu_book</span> Setup Guides
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Channel / Mail Setup Modal (global — not inside any view) -->
        <div class="modal-overlay" id="channel-setup-modal" style="display: none">
          <div class="modal-card channel-setup-modal-inner">
            <div class="modal-header">
              <h2 id="channel-setup-title">Set Up Channel</h2>
              <button class="btn-icon" id="channel-setup-close">&times;</button>
            </div>
            <div class="modal-body" id="channel-setup-body">
              <!-- Filled dynamically -->
            </div>
            <div class="modal-footer">
              <button class="btn btn-ghost" id="channel-setup-cancel">Cancel</button>
              <button class="btn btn-primary" id="channel-setup-save">Save &amp; Connect</button>
            </div>
          </div>
        </div>

        <!-- ═══ Nodes View — Engine Dashboard ═══ -->
        <div class="view list-view" id="nodes-view">
          <div class="view-header">
            <h1 class="view-title">
              <span
                class="ms ms-sm"
                style="display: inline; vertical-align: middle; margin-right: 6px"
                >device_hub</span
              >
              Engine
            </h1>
            <button class="btn btn-ghost btn-sm" id="nodes-refresh">
              <span class="ms ms-sm">sync</span>
              Refresh
            </button>
          </div>
          <div class="view-loading" id="nodes-loading" style="display: none">
            Loading engine status…
          </div>
          <div id="nodes-content" class="engine-dashboard"></div>
        </div>

        <!-- ═══ Trading View — Coinbase Dashboard ═══ -->
        <div class="view list-view" id="trading-view">
          <div class="view-header">
            <span class="view-title">Trading</span>
            <button class="btn-secondary" id="trading-refresh">
              <span class="ms ms-sm">sync</span>
              Refresh
            </button>
          </div>
          <div class="trading-toast" id="trading-toast" style="display: none"></div>
          <div id="trading-content">
            <div class="empty-state">
              <div class="empty-icon">
                <span class="ms" style="font-size: 48px">trending_up</span>
              </div>
              <div class="empty-title">Trading Dashboard</div>
              <div class="empty-subtitle">
                Enable the Coinbase skill and let your agents trade. Activity will appear here.
              </div>
              <div class="empty-prereqs" style="margin-top: 16px">
                <div class="empty-prereqs-title">Prerequisites</div>
                <div class="empty-prereq-item">
                  <span class="ms ms-sm">radio_button_unchecked</span> Enable the Coinbase skill
                </div>
                <div class="empty-prereq-item">
                  <span class="ms ms-sm">radio_button_unchecked</span> Add Coinbase API keys
                </div>
              </div>
              <div class="empty-actions" style="margin-top: 16px">
                <button class="btn btn-primary" id="trading-goto-skills">
                  <span class="ms ms-sm">bolt</span> Go to Skills
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Research View — Agent-powered research ═══ -->
        <div class="view" id="research-view">
          <!-- Sidebar: Projects + Recent -->
          <div class="research-sidebar">
            <div class="research-sidebar-header">
              <span class="research-sidebar-title">Research</span>
              <button class="btn-icon" id="research-new-project" title="New research project">
                <span class="ms ms-sm">add</span>
              </button>
            </div>

            <div class="research-sidebar-section">
              <div class="research-sidebar-label">Projects</div>
              <div class="research-project-list" id="research-project-list"></div>
            </div>

            <div class="research-sidebar-section">
              <div class="research-sidebar-label">Recent Queries</div>
              <div class="research-recent-list" id="research-recent-queries"></div>
            </div>

            <div class="research-sidebar-footer">
              <button
                class="btn btn-ghost btn-sm"
                id="research-open-workspace"
                title="Open in Finder"
              >
                <span class="ms ms-sm">folder_open</span>
                Open Folder
              </button>
            </div>
          </div>

          <!-- Main content area -->
          <div class="research-main">
            <!-- Empty state -->
            <div class="research-empty-state" id="research-empty">
              <div class="research-empty-icon">
                <span class="ms" style="font-size: 64px">search</span>
              </div>
              <h2 class="research-empty-title">Research Assistant</h2>
              <p class="research-empty-desc">
                Create a project, ask questions, and your AI agent will research the web — gathering
                sources, extracting insights, and building a knowledge base you can explore.
              </p>
              <button class="btn btn-primary btn-lg" id="research-create-first">
                <span class="ms ms-sm">add</span>
                New Research Project
              </button>
              <p class="research-empty-hint">
                Your findings are saved as markdown files in ~/Documents/Paw
              </p>
            </div>

            <!-- Active project workspace -->
            <div class="research-workspace" id="research-workspace" style="display: none">
              <!-- Project header -->
              <div class="research-project-header" id="research-project-header"></div>

              <!-- Search bar with mode toggle -->
              <div class="research-search-bar">
                <div class="research-mode-toggle">
                  <button
                    class="research-mode-btn active"
                    id="research-mode-quick"
                    title="Fast research (2-3 sources)"
                  >
                    <span class="ms ms-sm">bolt</span>
                    Quick
                  </button>
                  <button
                    class="research-mode-btn"
                    id="research-mode-deep"
                    title="Deep research (10+ sources)"
                  >
                    <span class="ms ms-sm">info</span>
                    Deep
                  </button>
                </div>
                <div class="research-input-wrapper">
                  <input
                    type="text"
                    class="research-topic-input"
                    id="research-topic-input"
                    placeholder="What do you want to research?"
                    autocomplete="off"
                  />
                  <button class="btn btn-primary research-run-btn" id="research-run-btn">
                    <span class="ms ms-sm">search</span>
                    Research
                  </button>
                  <button
                    class="btn btn-error research-stop-btn"
                    id="research-stop-btn"
                    style="display: none"
                  >
                    <span class="ms ms-sm">stop</span>
                    Stop
                  </button>
                </div>
              </div>

              <!-- Live research panel (shown during research) -->
              <div class="research-live-panel" id="research-live-panel" style="display: none">
                <div class="research-live-header">
                  <div class="research-live-title">
                    <div class="research-live-spinner"></div>
                    <span>Researching...</span>
                  </div>
                </div>

                <div class="research-live-body">
                  <!-- Progress steps -->
                  <div class="research-progress-steps" id="research-progress-steps"></div>

                  <!-- Live source feed -->
                  <div class="research-live-sources">
                    <div class="research-live-sources-label">Sources being checked:</div>
                    <div class="research-source-feed" id="research-source-feed"></div>
                  </div>

                  <!-- Live output stream -->
                  <div class="research-live-output">
                    <div class="research-live-output-label">Live output:</div>
                    <div class="research-live-content" id="research-live-content"></div>
                  </div>
                </div>
              </div>

              <!-- Findings + Sources layout -->
              <div class="research-content-layout" id="research-findings-area">
                <!-- Findings grid -->
                <div class="research-findings-section">
                  <div class="research-findings-header">
                    <h3>Findings</h3>
                    <button class="btn btn-primary btn-sm" id="research-generate-report">
                      <span class="ms ms-sm">description</span>
                      Generate Report
                    </button>
                  </div>
                  <div class="research-findings-grid" id="research-findings-grid"></div>
                </div>

                <!-- Sources panel -->
                <div class="research-sources-section">
                  <div class="research-sources-title">All Sources</div>
                  <div class="research-sources-panel" id="research-sources-panel"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Finding detail modal -->
          <div class="research-modal" id="research-detail-modal" style="display: none">
            <div class="research-modal-content research-modal-lg">
              <div class="research-modal-header">
                <h2>Finding Details</h2>
                <button class="btn-icon" id="research-detail-close">
                  <span class="ms ms-sm">close</span>
                </button>
              </div>
              <div class="research-modal-body" id="research-detail-content"></div>
            </div>
          </div>

          <!-- Report modal -->
          <div class="research-modal" id="research-report-modal" style="display: none">
            <div class="research-modal-content research-modal-lg">
              <div class="research-modal-header">
                <h2>Research Report</h2>
                <button class="btn-icon" id="research-report-close">
                  <span class="ms ms-sm">close</span>
                </button>
              </div>
              <div class="research-modal-body" id="research-report-content"></div>
            </div>
          </div>
        </div>

        <!-- ═══ Memory View — Knowledge Base ═══ -->
        <div class="view palace-view" id="memory-view">
          <!-- Memory setup banner (shown when plugin not configured) -->
          <div class="palace-install-banner" id="palace-install-banner" style="display: none">
            <div class="palace-install-card">
              <div class="palace-install-icon">
                <span class="ms" style="font-size: 48px">lightbulb</span>
              </div>
              <h2 class="palace-install-title">Enable Long-Term Memory</h2>
              <p class="palace-install-desc">
                Give your agent persistent vector memory with auto-capture and semantic recall.
                Works with OpenAI, Azure OpenAI, or any compatible endpoint — just add your API key.
              </p>
              <div class="palace-api-config" id="palace-api-config">
                <label class="palace-api-label" for="palace-provider">
                  Provider <span class="palace-api-required">*</span>
                </label>
                <select class="palace-api-input palace-api-select" id="palace-provider">
                  <option value="openai">OpenAI</option>
                  <option value="azure">Azure OpenAI</option>
                </select>
                <label class="palace-api-label" for="palace-api-key">
                  API Key <span class="palace-api-required">*</span>
                </label>
                <input
                  class="palace-api-input"
                  id="palace-api-key"
                  type="password"
                  placeholder="sk-..."
                  autocomplete="off"
                  spellcheck="false"
                />
                <div id="palace-azure-fields" style="display: none">
                  <label class="palace-api-label" for="palace-base-url">
                    Azure Endpoint <span class="palace-api-required">*</span>
                  </label>
                  <input
                    class="palace-api-input"
                    id="palace-base-url"
                    type="text"
                    placeholder="https://your-resource.openai.azure.com"
                    autocomplete="off"
                    spellcheck="false"
                  />
                  <p
                    class="palace-api-hint"
                    style="font-size: 11px; margin: -6px 0 8px 0; opacity: 0.6"
                  >
                    Your Azure resource endpoint (e.g. https://myresource.openai.azure.com).
                  </p>
                </div>
                <div id="palace-openai-endpoint-field">
                  <label class="palace-api-label" for="palace-base-url-openai">
                    Custom Endpoint
                    <span class="palace-api-hint">(optional — leave blank for api.openai.com)</span>
                  </label>
                  <input
                    class="palace-api-input"
                    id="palace-base-url-openai"
                    type="text"
                    placeholder="https://api.openai.com"
                    autocomplete="off"
                    spellcheck="false"
                  />
                </div>
                <label class="palace-api-label" for="palace-model-name" id="palace-model-label">
                  Model <span class="palace-api-hint">(defaults to text-embedding-3-small)</span>
                </label>
                <input
                  class="palace-api-input"
                  id="palace-model-name"
                  type="text"
                  placeholder="text-embedding-3-small"
                  autocomplete="off"
                  spellcheck="false"
                />
                <div id="palace-api-version-field" style="display: none">
                  <label class="palace-api-label" for="palace-api-version">
                    API Version
                    <span class="palace-api-hint">(defaults to 2024-08-01-preview)</span>
                  </label>
                  <input
                    class="palace-api-input"
                    id="palace-api-version"
                    type="text"
                    placeholder="2024-08-01-preview"
                    autocomplete="off"
                    spellcheck="false"
                  />
                </div>
              </div>
              <div
                class="palace-install-progress"
                id="palace-install-progress"
                style="display: none"
              >
                <p class="progress-text" id="palace-progress-text">Saving configuration…</p>
              </div>
              <div class="palace-install-actions">
                <div class="palace-btn-row">
                  <button class="btn btn-outline" id="palace-test-btn">Test Connection</button>
                  <button class="btn btn-primary" id="palace-install-btn">Enable Memory</button>
                </div>
                <button class="btn btn-ghost btn-sm" id="palace-skip-btn">
                  Skip — use file editor only
                </button>
              </div>
            </div>
          </div>
          <!-- Palace Sidebar -->
          <div class="palace-sidebar">
            <div class="palace-sidebar-header">
              <span class="palace-sidebar-title">Memory</span>
              <button
                class="btn-icon"
                id="palace-settings"
                title="Memory settings"
                style="display: none"
              >
                <span class="ms ms-sm">settings</span>
              </button>
              <button class="btn-icon" id="palace-export" title="Export all memories">
                <span class="ms ms-sm">download</span>
              </button>
              <button class="btn-icon" id="palace-refresh" title="Refresh memories">
                <span class="ms ms-sm">sync</span>
              </button>
            </div>
            <!-- Stats summary -->
            <div class="palace-stats" id="palace-stats">
              <div class="palace-stat">
                <span class="palace-stat-num" id="palace-total">—</span>
                <span class="palace-stat-label">Total</span>
              </div>
              <div class="palace-stat">
                <span class="palace-stat-num" id="palace-types">—</span>
                <span class="palace-stat-label">Types</span>
              </div>
              <div class="palace-stat">
                <span class="palace-stat-num" id="palace-graph-edges">—</span>
                <span class="palace-stat-label">Links</span>
              </div>
            </div>
            <!-- Filters -->
            <div class="palace-filters">
              <input
                class="palace-search-input"
                id="palace-search"
                placeholder="Search memories…"
              />
              <select class="palace-filter-select" id="palace-agent-filter">
                <option value="">All agents</option>
                <option value="">System (shared)</option>
              </select>
              <select class="palace-filter-select" id="palace-type-filter">
                <option value="">All types</option>
                <option value="fact">Facts</option>
                <option value="preference">Preferences</option>
                <option value="architecture">Architecture</option>
                <option value="decision">Decisions</option>
                <option value="insight">Insights</option>
                <option value="gotcha">Gotchas</option>
                <option value="event">Events</option>
                <option value="solution">Solutions</option>
              </select>
              <select class="palace-filter-select" id="palace-project-filter">
                <option value="">All projects</option>
              </select>
            </div>
            <!-- Memory list -->
            <div class="palace-memory-list" id="palace-memory-list">
              <div
                class="palace-list-empty"
                style="padding: 12px; color: var(--text-muted); font-size: 0.85rem"
              >
                Loading…
              </div>
            </div>
            <!-- Agent file fallback section -->
            <div class="palace-section-divider" id="palace-files-divider">
              <span>Agent Files</span>
              <button class="btn-icon" id="refresh-memory-btn" title="Refresh files">
                <span class="ms ms-sm">sync</span>
              </button>
            </div>
            <div class="palace-memory-list" id="memory-list"></div>
          </div>
          <!-- Palace Main -->
          <div class="palace-main">
            <!-- Tabs: Recall / Graph / Remember / Files -->
            <div class="palace-tabs">
              <button class="palace-tab active" data-palace-tab="recall">
                <span class="ms ms-sm">search</span>
                Recall
              </button>
              <button class="palace-tab" data-palace-tab="graph">
                <span class="ms ms-sm">hub</span>
                Map
              </button>
              <button class="palace-tab" data-palace-tab="remember">
                <span class="ms ms-sm">add</span>
                Remember
              </button>
              <button class="palace-tab" data-palace-tab="files">
                <span class="ms ms-sm">description</span>
                Files
              </button>
            </div>
            <!-- Recall Panel -->
            <div class="palace-panel active" id="palace-recall-panel">
              <div class="palace-recall-input-area">
                <textarea
                  class="palace-recall-input"
                  id="palace-recall-input"
                  placeholder="Search by meaning… e.g. 'How does authentication work?'"
                  rows="2"
                ></textarea>
                <button class="btn btn-primary btn-sm" id="palace-recall-btn">Recall</button>
              </div>
              <div class="palace-recall-results" id="palace-recall-results">
                <div class="empty-state" id="palace-recall-empty">
                  <div class="empty-icon">
                    <span class="ms" style="font-size: 48px">search</span>
                  </div>
                  <div class="empty-title">Semantic search</div>
                  <div class="empty-subtitle">
                    Search your agent's memories by meaning — not just keywords
                  </div>
                </div>
              </div>
            </div>
            <!-- Graph Panel -->
            <div class="palace-panel" id="palace-graph-panel">
              <div class="palace-graph-container" id="palace-graph-canvas">
                <div class="empty-state" id="palace-graph-empty">
                  <div class="empty-icon"><span class="ms" style="font-size: 48px">hub</span></div>
                  <div class="empty-title">Knowledge graph</div>
                  <div class="empty-subtitle">
                    Visual map of how your agent's memories connect to each other
                  </div>
                </div>
                <canvas
                  id="palace-graph-render"
                  width="800"
                  height="600"
                  style="display: none"
                ></canvas>
              </div>
            </div>
            <!-- Remember Panel -->
            <div class="palace-panel" id="palace-remember-panel">
              <div class="palace-remember-form">
                <div class="form-group">
                  <label class="form-label">Category</label>
                  <select class="form-input" id="palace-remember-type">
                    <option value="other">Other</option>
                    <option value="fact">Fact</option>
                    <option value="preference">Preference</option>
                    <option value="decision">Decision</option>
                    <option value="procedure">Procedure</option>
                    <option value="concept">Concept</option>
                    <option value="code">Code</option>
                    <option value="person">Person</option>
                    <option value="project">Project</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Content</label>
                  <textarea
                    class="form-input"
                    id="palace-remember-content"
                    rows="5"
                    placeholder="What should the agent remember?"
                  ></textarea>
                </div>
                <div class="form-group">
                  <label class="form-label">Importance (1–10)</label>
                  <select class="form-input" id="palace-remember-importance">
                    <option value="3">3 – Low</option>
                    <option value="5" selected>5 – Normal</option>
                    <option value="7">7 – High</option>
                    <option value="10">10 – Critical</option>
                  </select>
                </div>
                <button
                  class="btn btn-primary"
                  id="palace-remember-save"
                  style="align-self: flex-start"
                >
                  <span class="ms ms-sm" style="margin-right: 4px">add</span>
                  Store Memory
                </button>
              </div>
            </div>
            <!-- Files Panel (legacy agent files) -->
            <div class="palace-panel" id="palace-files-panel">
              <div
                class="memory-editor-panel"
                style="flex: 1; display: flex; flex-direction: column"
              >
                <div class="memory-editor" id="memory-editor" style="display: none">
                  <div class="memory-editor-header">
                    <span class="memory-editor-path" id="memory-editor-path"></span>
                    <div style="display: flex; gap: 6px">
                      <button class="btn btn-ghost btn-sm" id="memory-editor-close">Close</button>
                      <button class="btn btn-primary btn-sm" id="memory-editor-save">Save</button>
                    </div>
                  </div>
                  <textarea class="memory-editor-content" id="memory-editor-content"></textarea>
                </div>
                <div class="empty-state" id="memory-empty">
                  <div class="empty-icon">
                    <span class="ms" style="font-size: 48px">description</span>
                  </div>
                  <div class="empty-title">Agent files</div>
                  <div class="empty-subtitle">
                    Raw filesystem used by your agent for persistent storage
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="view-loading" id="memory-loading" style="display: none">Loading memory…</div>
        </div>

        <!-- ═══ Skills View — Community .md Prompt Skills (skills.sh) ═══ -->
        <div class="view skills-view" id="skills-view">
          <!-- Hero header -->
          <div class="skills-hero">
            <div class="skills-hero-left">
              <h1 class="skills-hero-title">Skills</h1>
              <p class="skills-hero-sub">Community <code>.md</code> prompt files from <a href="https://skills.sh" target="_blank" style="color:var(--accent);text-decoration:none">skills.sh</a> that teach your agents new abilities</p>
            </div>
            <div class="skills-hero-right">
              <div class="skills-hero-stat k-row k-spring">
                <span class="ms skills-hero-stat-icon">download</span>
                <div>
                  <div class="skills-hero-stat-val" id="skills-stat-installed">0</div>
                  <div class="skills-hero-stat-lbl">Installed</div>
                </div>
              </div>
              <div class="skills-hero-stat k-row k-spring">
                <span class="ms skills-hero-stat-icon">check_circle</span>
                <div>
                  <div class="skills-hero-stat-val" id="skills-stat-enabled">0</div>
                  <div class="skills-hero-stat-lbl">Enabled</div>
                </div>
              </div>
              <button class="btn btn-primary" id="refresh-skills-btn">
                <span class="ms ms-sm">sync</span>
                Refresh
              </button>
            </div>
          </div>

          <!-- Two-column body -->
          <div class="skills-body">
            <!-- Main column -->
            <div class="skills-main-col">
              <!-- Status toast -->
              <div class="skills-toast" id="skills-toast" style="display: none"></div>

              <!-- Content: installed skills + community browser -->
              <div class="skills-section k-row k-materialise">
                <div id="skills-tab-content">
                  <div
                    id="skills-vault-loading"
                    style="color: var(--text-muted); font-size: 13px; padding: 12px 0"
                  >
                    Loading skills...
                  </div>
                  <div id="skills-vault-list"></div>
                </div>
              </div>
            </div>

            <!-- Side panel -->
            <div class="skills-side-panel k-stagger">
              <!-- What Are Skills? -->
              <div class="skills-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">info</span>
                  <span class="skills-panel-card-title">What Are Skills?</span>
                </div>
                <div class="skills-panel-card-body">
                  <p>Skills are <strong>markdown prompt files</strong> (<code>.md</code>) that teach your agent how to do something specific — instructions, personality traits, or domain knowledge.</p>
                  <p>Unlike integrations (which call APIs) or built-in tools (compiled into the engine), skills shape <em>how</em> your agent thinks and responds.</p>
                </div>
              </div>

              <!-- skills.sh -->
              <div class="skills-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">public</span>
                  <span class="skills-panel-card-title">skills.sh</span>
                </div>
                <div class="skills-panel-card-body">
                  <p><a href="https://skills.sh" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600">skills.sh</a> is the community skill directory. Browse, search, and install open-source <code>.md</code> skills created by the community.</p>
                  <p>Skills work across all channels — WhatsApp, Telegram, Discord, Slack, and more.</p>
                </div>
              </div>

              <!-- How It Works -->
              <div class="skills-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">psychology</span>
                  <span class="skills-panel-card-title">How It Works</span>
                </div>
                <div class="skills-panel-card-body">
                  <ul class="skills-explainer-list">
                    <li><span class="ms">upload_file</span> Skill <code>.md</code> files are loaded into the agent's context window</li>
                    <li><span class="ms">auto_awesome</span> The agent reads the instructions and follows them during conversations</li>
                    <li><span class="ms">tune</span> Multiple skills combine — an agent can have many skills active at once</li>
                    <li><span class="ms">person</span> Assign skills to specific agents or share across all</li>
                  </ul>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="skills-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">rocket_launch</span>
                  <span class="skills-panel-card-title">Quick Actions</span>
                </div>
                <div class="skills-quick-actions">
                  <button class="skills-quick-btn" id="skills-qa-refresh">
                    <span class="ms">sync</span> Refresh All
                  </button>
                  <button class="skills-quick-btn" id="skills-qa-browse-community">
                    <span class="ms">explore</span> Browse skills.sh
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ PawzHub View — REMOVED (n8n replaces marketplace) ═══ -->
        <!-- PawzHub view kept hidden — code not deleted yet, redirect goes to Integrations -->
        <div class="view" id="pawzhub-view" style="display:none !important"></div>

        <!-- ═══ Flows View — Flow Visualization Engine ═══ -->
        <div class="view flows-view" id="flows-view">
          <div class="flows-hero">
            <div class="flows-hero-left">
              <h1 class="flows-hero-title">Flows</h1>
              <p class="flows-hero-sub">Visualize and build AI workflows</p>
            </div>
            <div class="flows-hero-right">
              <div class="flows-hero-stat k-row k-spring">
                <span class="ms flows-hero-stat-icon">account_tree</span>
                <div>
                  <div class="flows-hero-stat-val" id="flows-stat-total">0</div>
                  <div class="flows-hero-stat-lbl">Flows</div>
                </div>
              </div>
              <div class="flows-hero-stat k-row k-spring">
                <span class="ms flows-hero-stat-icon">hub</span>
                <div>
                  <div class="flows-hero-stat-val" id="flows-stat-integrations">0</div>
                  <div class="flows-hero-stat-lbl">Integrations</div>
                </div>
              </div>
              <div class="flows-hero-stat k-row k-spring">
                <span class="ms flows-hero-stat-icon">schedule</span>
                <div>
                  <div class="flows-hero-stat-val" id="flows-stat-scheduled">0</div>
                  <div class="flows-hero-stat-lbl">Scheduled</div>
                </div>
              </div>
              <div class="flows-hero-text-input">
                <input type="text" class="flows-text-box" id="flows-text-input"
                  placeholder="Describe a flow… e.g. webhook -> agent -> send email"
                  autocomplete="off" />
              </div>
            </div>
          </div>
          <div id="flows-list"></div>
          <div id="flows-toolbar"></div>
          <div id="flows-canvas"></div>
          <div id="flows-panel"></div>
          <button class="flows-edge-tab flows-edge-tab-left" id="flows-edge-tab-left" title="Show flow list">
            <span class="ms">left_panel_open</span>
          </button>
          <button class="flows-edge-tab flows-edge-tab-right" id="flows-edge-tab-right" title="Show properties panel">
            <span class="ms">right_panel_open</span>
          </button>
        </div>

        <!-- ═══ Foundry View — Models & Modes ═══ -->
        <div class="view foundry-view" id="foundry-view">
          <!-- Kinetic hero header -->
          <div class="foundry-hero">
            <div class="foundry-hero-left">
              <h1 class="foundry-hero-title">Foundry</h1>
              <p class="foundry-hero-sub">Configure AI providers, models, and agent behaviour modes</p>
              <div class="foundry-tabs">
                <button class="foundry-tab active" data-foundry-tab="models">Models</button>
                <button class="foundry-tab" data-foundry-tab="modes">Chat Modes</button>
              </div>
            </div>
            <div class="foundry-hero-right">
              <div class="foundry-hero-stat k-row k-spring">
                <span class="ms foundry-hero-stat-icon">dns</span>
                <div>
                  <div class="foundry-hero-stat-val" id="foundry-stat-providers">0</div>
                  <div class="foundry-hero-stat-lbl">Providers</div>
                </div>
              </div>
              <div class="foundry-hero-stat k-row k-spring">
                <span class="ms foundry-hero-stat-icon">view_in_ar</span>
                <div>
                  <div class="foundry-hero-stat-val" id="foundry-stat-models">0</div>
                  <div class="foundry-hero-stat-lbl">Models</div>
                </div>
              </div>
              <div class="foundry-hero-stat k-row k-spring">
                <span class="ms foundry-hero-stat-icon">tune</span>
                <div>
                  <div class="foundry-hero-stat-val" id="foundry-stat-modes">0</div>
                  <div class="foundry-hero-stat-lbl">Modes</div>
                </div>
              </div>
              <button class="btn btn-ghost btn-sm" id="refresh-models-btn">
                <span class="ms ms-sm">sync</span>
                Refresh
              </button>
            </div>
          </div>

          <!-- Two-column body -->
          <div class="foundry-body">
            <!-- Main column -->
            <div class="foundry-main-col">
              <!-- Models Tab -->
              <div class="foundry-panel" id="foundry-models-panel">
                <div class="models-grid" id="models-list"></div>
                <div class="empty-state" id="models-empty">
                  <div class="empty-icon">
                    <span class="ms" style="font-size: 48px">view_in_ar</span>
                  </div>
                  <div class="empty-title">No models available</div>
                  <div class="empty-subtitle">
                    Configure your AI provider in Settings to see available models
                  </div>
                  <div class="empty-actions" style="margin-top: 16px">
                    <button class="btn btn-primary" id="foundry-goto-settings">
                      <span class="ms ms-sm">settings</span> Go to Settings
                    </button>
                  </div>
                </div>
                <div class="view-loading" id="models-loading" style="display: none">
                  Loading models…
                </div>
              </div>
              <!-- Agent Modes Tab -->
              <div class="foundry-panel" id="foundry-modes-panel" style="display: none">
                <div class="modes-header">
                  <p class="modes-description">
                    Agent modes are named configurations — each with its own model, system prompt, and
                    skill set.
                  </p>
                  <button class="btn btn-primary btn-sm" id="modes-add-btn">
                    <span class="ms ms-sm">add</span>
                    New Mode
                  </button>
                </div>
                <div class="modes-list" id="modes-list"></div>
                <div class="empty-state" id="modes-empty" style="display: none">
                  <div class="empty-title">No modes yet</div>
                  <div class="empty-subtitle">Create modes to quickly switch your agent's behavior</div>
                </div>
              </div>
            </div>
            <!-- /foundry-main-col -->

            <!-- Side panel -->
            <div class="foundry-side-panel k-stagger">
              <!-- What Is Foundry? -->
              <div class="foundry-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">info</span>
                  <span class="skills-panel-card-title">Foundry</span>
                </div>
                <div class="skills-panel-card-body">
                  <p>The Foundry is your AI configuration hub. Add providers, browse available models, and create custom agent modes that shape how your agents think and respond.</p>
                </div>
              </div>

              <!-- Models -->
              <div class="foundry-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">view_in_ar</span>
                  <span class="skills-panel-card-title">Models</span>
                </div>
                <div class="skills-panel-card-body">
                  <ul class="skills-explainer-list">
                    <li><span class="ms">dns</span> Connect multiple AI providers at once</li>
                    <li><span class="ms">star</span> Set default model for all conversations</li>
                    <li><span class="ms">key</span> API key management per provider</li>
                    <li><span class="ms">home</span> Local models via Ollama support</li>
                  </ul>
                </div>
              </div>

              <!-- Chat Modes -->
              <div class="foundry-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">tune</span>
                  <span class="skills-panel-card-title">Chat Modes</span>
                </div>
                <div class="skills-panel-card-body">
                  <p>Named presets with a custom model, system prompt, thinking level, and temperature. Switch modes instantly to change agent behaviour mid-conversation.</p>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="foundry-panel-card k-row k-spring k-materialise">
                <div class="skills-panel-card-header">
                  <span class="ms skills-panel-card-icon">rocket_launch</span>
                  <span class="skills-panel-card-title">Quick Actions</span>
                </div>
                <div class="skills-quick-actions">
                  <button class="skills-quick-btn" id="foundry-qa-refresh">
                    <span class="ms">sync</span> Refresh Models
                  </button>
                  <button class="skills-quick-btn" id="foundry-qa-new-mode">
                    <span class="ms">add</span> New Mode
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- /foundry-body -->
          <!-- Mode Editor Modal -->
          <div class="modal-overlay" id="mode-modal" style="display: none">
            <div class="modal-card modal-lg">
              <div class="modal-header">
                <h2 class="modal-title" id="mode-modal-title">New Agent Mode</h2>
                <button class="btn-icon" id="mode-modal-close">✕</button>
              </div>
              <div class="modal-body">
                <div class="form-row">
                  <div class="form-group" style="flex: 0 0 60px">
                    <label class="form-label">Icon</label>
                    <input
                      type="text"
                      class="form-input form-input-icon"
                      id="mode-form-icon"
                      value=""
                      maxlength="2"
                    />
                  </div>
                  <div class="form-group" style="flex: 1">
                    <label class="form-label">Name</label>
                    <input
                      type="text"
                      class="form-input"
                      id="mode-form-name"
                      placeholder="Code Review"
                    />
                  </div>
                  <div class="form-group" style="flex: 0 0 100px">
                    <label class="form-label">Color</label>
                    <input
                      type="color"
                      class="form-input form-input-color"
                      id="mode-form-color"
                      value="#0073EA"
                    />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Model (leave blank for default)</label>
                  <select class="form-input" id="mode-form-model">
                    <option value="">Default model</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">System Prompt</label>
                  <textarea
                    class="form-input"
                    id="mode-form-prompt"
                    rows="4"
                    placeholder="You are a careful code reviewer..."
                  ></textarea>
                </div>
                <div class="form-row">
                  <div class="form-group" style="flex: 1">
                    <label class="form-label">Thinking Level</label>
                    <select class="form-input" id="mode-form-thinking">
                      <option value="none">None</option>
                      <option value="low">Low</option>
                      <option value="normal" selected>Normal</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                  <div class="form-group" style="flex: 1">
                    <label class="form-label">Temperature</label>
                    <input
                      type="range"
                      class="form-range"
                      id="mode-form-temp"
                      min="0"
                      max="2"
                      step="0.1"
                      value="1"
                    />
                    <span class="form-range-value" id="mode-form-temp-value">1.0</span>
                  </div>
                </div>
                <!-- Phase A: Auto-approve toggle -->
                <div class="form-group" id="mode-form-autoapprove-group">
                  <label
                    class="form-label"
                    style="display: flex; align-items: center; gap: 8px; cursor: pointer"
                  >
                    <input type="checkbox" id="mode-form-autoapprove" />
                    <span>Auto-Approve All Tools</span>
                    <span class="badge badge-warning" style="font-size: 0.7rem">⚡ Autonomous</span>
                  </label>
                  <p
                    class="form-hint"
                    id="mode-form-autoapprove-warning"
                    style="display: none; color: var(--warning); margin-top: 4px; font-size: 0.8rem"
                  >
                    ⚠️ This agent will execute <strong>all</strong> tools without asking — including
                    file writes, shell commands, and API calls. Use with container sandbox enabled.
                  </p>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" id="mode-modal-cancel">Cancel</button>
                <button class="btn btn-error btn-sm" id="mode-modal-delete" style="display: none">
                  Delete
                </button>
                <button class="btn btn-primary" id="mode-modal-save">Save Mode</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ Settings View ═══ -->
        <div class="view settings-view" id="settings-view">
          <div class="settings-layout">
            <!-- Vertical Settings Sidebar -->
            <nav
              class="settings-sidebar"
              id="settings-tab-bar"
            >
              <div class="settings-sidebar-title">SYSTEM CONFIG</div>

              <div class="settings-nav-section">CORE</div>
              <button class="settings-nav-item active" data-settings-tab="general">
                <span class="ms ms-sm">tune</span> General
              </button>
              <button class="settings-nav-item" data-settings-tab="models">
                <span class="ms ms-sm">model_training</span> Providers
              </button>
              <button class="settings-nav-item" data-settings-tab="agent-defaults">
                <span class="ms ms-sm">smart_toy</span> Agent Defaults
              </button>
              <button class="settings-nav-item" data-settings-tab="sessions">
                <span class="ms ms-sm">forum</span> Sessions
              </button>

              <div class="settings-nav-section">VOICE</div>
              <button class="settings-nav-item" data-settings-tab="voice">
                <span class="ms ms-sm">mic</span> Voice &amp; TTS
              </button>
              <button class="settings-nav-item" data-settings-tab="browser">
                <span class="ms ms-sm">language</span> Browser &amp; Sandbox
              </button>

              <div class="settings-nav-section">NETWORK</div>
              <button class="settings-nav-item" data-settings-tab="tailscale">
                <span class="ms ms-sm">vpn_lock</span> Tailscale
              </button>
              <button class="settings-nav-item" data-settings-tab="webhook">
                <span class="ms ms-sm">webhook</span> Webhook
              </button>
              <button class="settings-nav-item" data-settings-tab="n8n">
                <span class="ms ms-sm">account_tree</span> n8n
              </button>
              <button class="settings-nav-item" data-settings-tab="mcp">
                <span class="ms ms-sm">dns</span> MCP Servers
              </button>

              <div class="settings-nav-section">SYSTEM</div>
              <button class="settings-nav-item" data-settings-tab="storage">
                <span class="ms ms-sm">folder_open</span> Storage
              </button>
              <button class="settings-nav-item" data-settings-tab="security">
                <span class="ms ms-sm">security</span> Security
              </button>
              <button class="settings-nav-item" data-settings-tab="memory">
                <span class="ms ms-sm">psychology</span> Memory
              </button>
              <button class="settings-nav-item" data-settings-tab="engine">
                <span class="ms ms-sm">memory</span> Engine
              </button>
              <button class="settings-nav-item" data-settings-tab="logs">
                <span class="ms ms-sm">terminal</span> Logs
              </button>
            </nav>

            <!-- Settings Content Area -->
            <div class="settings-content">

          <!-- ── Tab: General ── -->
          <div class="settings-tab-panel" id="settings-panel-general">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">tune</span>
              <div>
                <h2 class="settings-panel-hero-title">General</h2>
                <p class="settings-panel-hero-sub">Theme, software updates, and about information</p>
              </div>
            </div>
            <!-- Hidden select kept for compatibility -->
            <select class="form-input" id="settings-engine-mode" style="display: none">
              <option value="engine" selected>Built-in Paw Engine</option>
            </select>
            <div id="engine-config-panel" style="display: none"></div>

            <!-- Appearance — Theme Picker -->
            <div class="settings-section" id="settings-appearance-section">
              <h2 class="settings-section-title">Appearance</h2>
              <p class="settings-section-desc" style="margin-bottom: 12px">
                Customize the look and feel of Pawz.
              </p>
              <div class="form-group">
                <label class="form-label" style="margin-bottom: 8px">Theme</label>
                <div id="theme-grid" class="theme-grid"></div>
              </div>
            </div>

            <div class="settings-section">
              <h2 class="settings-section-title">About</h2>
              <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.8">
                <strong>Pawz</strong> v0.1.0 — Your AI command center<br />
                Pawz are safer than Claws<br />
                <a
                  href="https://github.com/OpenPawz/openpawz"
                  target="_blank"
                  style="color: var(--accent)"
                  >View source on GitHub</a
                >
              </p>
            </div>

            <!-- ── Software Update ── -->
            <div class="settings-section">
              <h2 class="settings-section-title">Software Update</h2>
              <p class="settings-section-desc" style="margin-bottom: 12px">
                Check for new versions and update Pawz in-place.
              </p>
              <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap">
                <button class="btn btn-primary btn-sm" id="settings-update-check">
                  <span class="ms ms-sm" style="margin-right: 4px">refresh</span>
                  Check for Updates
                </button>
                <button
                  class="btn btn-accent btn-sm"
                  id="settings-update-install"
                  style="display: none"
                >
                  <span class="ms ms-sm" style="margin-right: 4px">download</span>
                  Download &amp; Install
                </button>
              </div>
              <p
                id="update-status"
                style="color: var(--text-muted); font-size: 12px; margin-top: 8px"
              ></p>
            </div>
          </div>
          <!-- end settings-panel-general -->

          <!-- ── Tab: Providers ── -->
          <div class="settings-tab-panel" id="settings-panel-models" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">model_training</span>
              <div>
                <h2 class="settings-panel-hero-title">Providers &amp; Models</h2>
                <p class="settings-panel-hero-sub">Add AI providers, manage API keys, and configure model routing</p>
              </div>
            </div>
            <div class="settings-section" id="settings-models-section">
              <div id="settings-models-content"></div>
            </div>
          </div>

          <!-- ── Tab: Agent Defaults ── -->
          <div class="settings-tab-panel" id="settings-panel-agent-defaults" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">smart_toy</span>
              <div>
                <h2 class="settings-panel-hero-title">Agent Defaults</h2>
                <p class="settings-panel-hero-sub">Default model, tool execution limits, system prompt, and memory settings</p>
              </div>
            </div>
            <div class="settings-section" id="settings-agent-defaults-section">
              <div id="settings-agent-defaults-content"></div>
            </div>
          </div>

          <!-- ── Tab: Sessions ── -->
          <div class="settings-tab-panel" id="settings-panel-sessions" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">forum</span>
              <div>
                <h2 class="settings-panel-hero-title">Sessions</h2>
                <p class="settings-panel-hero-sub">View, rename, and manage chat sessions</p>
              </div>
            </div>
            <div class="settings-section" id="settings-sessions-section">
              <div id="settings-sessions-content"></div>
            </div>
          </div>

          <!-- ── Tab: Voice & TTS ── -->
          <div class="settings-tab-panel" id="settings-panel-voice" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">mic</span>
              <div>
                <h2 class="settings-panel-hero-title">Voice &amp; TTS</h2>
                <p class="settings-panel-hero-sub">Text-to-speech, talk mode, and voice wake triggers</p>
              </div>
            </div>
            <div class="settings-section" id="settings-voice-section">
              <div id="settings-voice-content"></div>
            </div>
          </div>

          <!-- ── Tab: Browser & Sandbox ── -->
          <div class="settings-tab-panel" id="settings-panel-browser" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">language</span>
              <div>
                <h2 class="settings-panel-hero-title">Browser &amp; Sandbox</h2>
                <p class="settings-panel-hero-sub">Chrome profiles, agent screenshots, workspaces, and network policy</p>
              </div>
            </div>
            <div class="settings-section">
              <div id="settings-browser-sandbox-content"></div>
            </div>
          </div>

          <!-- ── Tab: Tailscale ── -->
          <div class="settings-tab-panel" id="settings-panel-tailscale" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">vpn_lock</span>
              <div>
                <h2 class="settings-panel-hero-title">Tailscale</h2>
                <p class="settings-panel-hero-sub">Expose Pawz to your Tailscale network or the internet via Serve and Funnel</p>
              </div>
            </div>
            <div class="settings-section">
              <div id="settings-tailscale-content"></div>
            </div>
          </div>

          <!-- ── Tab: Webhook ── -->
          <div class="settings-tab-panel" id="settings-panel-webhook" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">webhook</span>
              <div>
                <h2 class="settings-panel-hero-title">Inbound Webhook</h2>
                <p class="settings-panel-hero-sub">Let external systems POST to a local endpoint to trigger agent runs</p>
              </div>
            </div>
            <div class="settings-section">
              <div id="settings-webhook-content"></div>

              <!-- Webhook Event Log -->
              <div class="webhook-log-section">
                <h3 class="settings-subsection-title">
                  <span class="ms ms-sm">receipt_long</span>
                  Event Log
                </h3>
                <div class="webhook-log-list" id="webhook-log-list">
                  <div class="webhook-log-empty">No webhook events received yet</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ── Tab: n8n Integration ── -->
          <div class="settings-tab-panel" id="settings-panel-n8n" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">account_tree</span>
              <div>
                <h2 class="settings-panel-hero-title">n8n Integration</h2>
                <p class="settings-panel-hero-sub">Connect to n8n for 25,000+ service integrations via workflows and MCP bridge</p>
              </div>
            </div>
            <div class="settings-section">
              <div id="settings-n8n-content"></div>
            </div>
          </div>

          <!-- ── Tab: MCP Servers ── -->
          <div class="settings-tab-panel" id="settings-panel-mcp" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">dns</span>
              <div>
                <h2 class="settings-panel-hero-title">MCP Servers</h2>
                <p class="settings-panel-hero-sub">Extend agents with external tools and data sources via Model Context Protocol</p>
              </div>
            </div>
            <div class="settings-section">
              <div id="settings-mcp-content"></div>
            </div>
          </div>

          <!-- ── Tab: Storage ── -->
          <div class="settings-tab-panel" id="settings-panel-storage" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">folder_open</span>
              <div>
                <h2 class="settings-panel-hero-title">Storage</h2>
                <p class="settings-panel-hero-sub">Data locations, workspace path, and cloud sync</p>
              </div>
            </div>
            <div class="settings-section" id="settings-storage-section">
              <div id="settings-storage-content"></div>
            </div>
          </div>

          <!-- ── Tab: Security ── -->
          <div class="settings-tab-panel" id="settings-panel-security" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">security</span>
              <div>
                <h2 class="settings-panel-hero-title">Security</h2>
                <p class="settings-panel-hero-sub">Tool approvals, audit log, and execution policies</p>
              </div>
            </div>
            <!-- Exec Approvals Config -->
            <div class="settings-section" id="settings-approvals-section" style="display: none">
              <h2 class="settings-section-title">Tool Approval Rules</h2>
              <p class="settings-section-desc">
                Choose which tools your agent can use automatically and which need your permission.
              </p>

              <!-- Default behaviour radio group -->
              <div class="approvals-default-policy">
                <div class="approvals-policy-label">When a tool isn't listed below:</div>
                <div class="approvals-policy-options" id="approvals-ask-policy">
                  <label class="approvals-policy-option">
                    <input type="radio" name="approvals-policy" value="ask" checked />
                    <div class="approvals-policy-card">
                      <span class="ms ms-sm">info</span>
                      <span>Ask me</span>
                    </div>
                  </label>
                  <label class="approvals-policy-option">
                    <input type="radio" name="approvals-policy" value="allow" />
                    <div class="approvals-policy-card">
                      <span class="ms ms-sm">check_circle</span>
                      <span>Allow</span>
                    </div>
                  </label>
                  <label class="approvals-policy-option">
                    <input type="radio" name="approvals-policy" value="deny" />
                    <div class="approvals-policy-card">
                      <span class="ms ms-sm">block</span>
                      <span>Block</span>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Tool rules list (rendered dynamically) -->
              <div class="approvals-tool-list" id="approvals-tool-list">
                <!-- Each tool rendered as a row with a 3-way toggle -->
              </div>

              <button class="btn btn-ghost btn-sm" id="approvals-add-tool" style="margin-top: 8px">
                <span class="ms ms-sm">add</span>
                Add rule
              </button>

              <div style="display: flex; gap: 8px; margin-top: 16px">
                <button class="btn btn-primary" id="settings-save-approvals">Save Rules</button>
                <button class="btn btn-ghost btn-sm" id="settings-refresh-approvals">Reload</button>
              </div>
            </div>

            <!-- Security Audit Dashboard -->
            <div class="settings-section" id="settings-audit-section">
              <h2 class="settings-section-title">
                <span class="ms ms-sm">description</span>
                Security Audit Log
              </h2>
              <p class="settings-section-desc">
                All security-relevant events — exec approvals, auto-denies, auto-allows, and policy
                changes.
              </p>

              <!-- Encryption status indicator (C2) -->
              <div class="encryption-status-bar" id="encryption-status-bar">
                <span class="encryption-status-dot" id="encryption-status-dot"></span>
                <span id="encryption-status-text">Checking encryption...</span>
              </div>

              <!-- Keychain health indicator (Phase 3B) -->
              <div class="keychain-health-bar" id="keychain-health-bar" style="display: none">
                <span class="keychain-health-dot" id="keychain-health-dot"></span>
                <span id="keychain-health-text">Checking keychain...</span>
                <span id="keychain-health-detail" class="keychain-health-detail"></span>
              </div>

              <div class="audit-controls">
                <select class="form-input audit-filter-select" id="audit-filter-type">
                  <option value="">All events</option>
                  <option value="exec_approval">Exec approvals</option>
                  <option value="auto_deny">Auto-denied</option>
                  <option value="auto_allow">Auto-allowed</option>
                  <option value="credential_access">Credential access</option>
                  <option value="security_policy">Policy changes</option>
                  <option value="network_request">Network requests</option>
                  <option value="engine_crash">Engine crashes</option>
                  <option value="scope_violation">Scope violations</option>
                </select>
                <select class="form-input audit-filter-select" id="audit-filter-risk">
                  <option value="">All risk levels</option>
                  <option value="critical">Critical</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                  <option value="safe">Safe</option>
                </select>
                <select class="form-input audit-filter-select" id="audit-filter-limit">
                  <option value="50">Last 50</option>
                  <option value="100" selected>Last 100</option>
                  <option value="250">Last 250</option>
                  <option value="500">Last 500</option>
                </select>
                <button class="btn btn-ghost btn-sm" id="audit-refresh">Refresh</button>
                <button class="btn btn-ghost btn-sm" id="audit-export-json" title="Export as JSON">
                  Export JSON
                </button>
                <button class="btn btn-ghost btn-sm" id="audit-export-csv" title="Export as CSV">
                  Export CSV
                </button>
              </div>

              <!-- Security score card -->
              <div class="audit-score-card" id="audit-score-card">
                <div class="audit-score-item" id="audit-score-csp">
                  <span class="audit-score-icon"><span class="ms ms-sm">verified</span></span>
                  <span class="audit-score-label">CSP Active</span>
                </div>
                <div class="audit-score-item" id="audit-score-denied">
                  <span class="audit-score-icon"><span class="ms ms-sm">shield</span></span>
                  <span class="audit-score-label" id="audit-score-denied-label">0 blocked</span>
                </div>
                <div class="audit-score-item" id="audit-score-allowed">
                  <span class="audit-score-icon"><span class="ms ms-sm">check</span></span>
                  <span class="audit-score-label" id="audit-score-allowed-label">0 allowed</span>
                </div>
                <div class="audit-score-item" id="audit-score-critical">
                  <span class="audit-score-icon"><span class="ms ms-sm">warning</span></span>
                  <span class="audit-score-label" id="audit-score-critical-label">0 critical</span>
                </div>
              </div>

              <div class="audit-table-wrapper" id="audit-table-wrapper">
                <table class="audit-table" id="audit-log-table">
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Event</th>
                      <th>Risk</th>
                      <th>Tool</th>
                      <th>Detail</th>
                      <th>Result</th>
                    </tr>
                  </thead>
                  <tbody id="audit-log-body"></tbody>
                </table>
              </div>
              <div class="audit-empty" id="audit-empty" style="display: none">
                No security events recorded yet.
              </div>
            </div>

            <!-- Security Policies -->
            <div class="settings-section" id="settings-security-section">
              <h2 class="settings-section-title">
                <span class="ms ms-sm">shield</span>
                Security Policies
              </h2>
              <p class="settings-section-desc">
                Controls how Paw handles dangerous commands from the agent.
              </p>

              <!-- Session override banner -->
              <div
                class="session-override-banner"
                id="session-override-banner"
                style="display: none"
              >
                <div class="session-override-banner-text">
                  <span class="session-override-banner-icon">⏱</span>
                  <span id="session-override-banner-label">Session override active</span>
                </div>
                <button class="btn btn-ghost btn-sm" id="session-override-cancel">
                  Cancel Override
                </button>
              </div>

              <div class="security-toggles">
                <label class="security-toggle-row">
                  <input type="checkbox" id="sec-auto-deny-priv" />
                  <div class="security-toggle-info">
                    <div class="security-toggle-label">Auto-deny privilege escalation</div>
                    <div class="security-toggle-desc">
                      Automatically block sudo, su, doas, pkexec, and runas commands without asking
                    </div>
                  </div>
                </label>
                <label class="security-toggle-row">
                  <input type="checkbox" id="sec-auto-deny-critical" />
                  <div class="security-toggle-info">
                    <div class="security-toggle-label">Auto-deny all critical-risk commands</div>
                    <div class="security-toggle-desc">
                      Automatically block fork bombs, remote code execution, disk destruction, etc.
                    </div>
                  </div>
                </label>
                <label class="security-toggle-row">
                  <input type="checkbox" id="sec-require-type" checked />
                  <div class="security-toggle-info">
                    <div class="security-toggle-label">
                      Require typing "ALLOW" for critical commands
                    </div>
                    <div class="security-toggle-desc">
                      Instead of clicking a button, you must type ALLOW to approve dangerous
                      commands
                    </div>
                  </div>
                </label>
                <label class="security-toggle-row">
                  <input type="checkbox" id="sec-read-only-projects" />
                  <div class="security-toggle-info">
                    <div class="security-toggle-label">Read-only project mode</div>
                    <div class="security-toggle-desc">
                      Block agent filesystem write tools (create, edit, delete, move) — the agent
                      can only read files
                    </div>
                  </div>
                </label>
              </div>

              <h3 class="settings-subsection-title" style="margin-top: 20px">
                Token Auto-Rotation
              </h3>
              <p class="settings-section-desc">
                Automatically rotate device tokens after a set number of days. Set to 0 to disable.
              </p>
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px">
                <select class="form-input" id="sec-token-rotation-interval" style="width: 200px">
                  <option value="0">Disabled</option>
                  <option value="7">Every 7 days</option>
                  <option value="14">Every 14 days</option>
                  <option value="30">Every 30 days</option>
                  <option value="60">Every 60 days</option>
                  <option value="90">Every 90 days</option>
                </select>
                <span
                  class="settings-section-desc"
                  id="sec-token-rotation-status"
                  style="margin: 0"
                ></span>
              </div>

              <h3 class="settings-subsection-title" style="margin-top: 20px">Command Allowlist</h3>
              <p class="settings-section-desc">
                Regex patterns for commands that are always auto-approved (bypasses the approval
                modal). One pattern per line.
              </p>
              <textarea
                class="form-input security-patterns-input"
                id="sec-allowlist"
                rows="6"
                placeholder="^git\b&#10;^npm\b&#10;^ls\b"
              ></textarea>

              <h3 class="settings-subsection-title" style="margin-top: 16px">Command Denylist</h3>
              <p class="settings-section-desc">
                Regex patterns for commands that are always auto-denied. One pattern per line.
              </p>
              <textarea
                class="form-input security-patterns-input"
                id="sec-denylist"
                rows="6"
                placeholder="\bsudo\b&#10;\brm\s+-rf\s+/"
              ></textarea>

              <div style="display: flex; gap: 8px; margin-top: 16px">
                <button class="btn btn-primary" id="settings-save-security">
                  Save Security Policies
                </button>
                <button class="btn btn-ghost btn-sm" id="settings-reset-security">
                  Reset to Defaults
                </button>
              </div>
            </div>
          </div>
          <!-- end settings-panel-security -->

          <!-- ── Tab: Memory ── -->
          <div class="settings-tab-panel" id="settings-panel-memory" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">psychology</span>
              <div>
                <h2 class="settings-panel-hero-title">Memory</h2>
                <p class="settings-panel-hero-sub">Agent memory and knowledge base management</p>
              </div>
            </div>
            <div id="settings-memory-container"></div>
          </div>

          <!-- ── Tab: Engine ── -->
          <div class="settings-tab-panel" id="settings-panel-engine" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">memory</span>
              <div>
                <h2 class="settings-panel-hero-title">Engine</h2>
                <p class="settings-panel-hero-sub">Paw engine configuration and diagnostics</p>
              </div>
            </div>
            <div id="settings-engine-container"></div>
          </div>

          <!-- ── Tab: Logs ── -->
          <div class="settings-tab-panel" id="settings-panel-logs" style="display: none">
            <div class="settings-panel-hero">
              <span class="ms settings-panel-hero-icon">terminal</span>
              <div>
                <h2 class="settings-panel-hero-title">Logs</h2>
                <p class="settings-panel-hero-sub">Live application logs with 7-day retention in ~/Documents/Paw/logs/</p>
              </div>
            </div>
            <div class="settings-section">
              <div id="settings-logs-content"></div>
            </div>
          </div>
            </div>
            <!-- end settings-content -->
          </div>
          <!-- end settings-layout -->
        </div>
      </main>
    </div>

    <!-- Global Toast -->
    <div class="global-toast" id="global-toast" style="display: none"></div>

    <!-- Exec Approval Modal -->
    <div class="modal-overlay" id="approval-modal" style="display: none">
      <div class="modal-card" id="approval-modal-card" style="width: 480px">
        <div class="modal-header" id="approval-modal-header">
          <h2 class="modal-title" id="approval-modal-title">Tool Approval Required</h2>
          <button class="btn-icon" id="approval-modal-close">✕</button>
        </div>
        <!-- Risk badge (hidden by default, shown for dangerous commands) -->
        <div class="approval-risk-banner" id="approval-risk-banner" style="display: none">
          <div class="approval-risk-icon" id="approval-risk-icon">⚠</div>
          <div class="approval-risk-info">
            <div class="approval-risk-label" id="approval-risk-label">DANGER</div>
            <div class="approval-risk-reason" id="approval-risk-reason"></div>
          </div>
        </div>
        <!-- Network request audit banner (C5) -->
        <div id="approval-network-banner" class="network-banner" style="display: none"></div>
        <div class="modal-body">
          <p id="approval-modal-desc" style="color: var(--text-secondary); margin-bottom: 12px"></p>
          <div id="approval-modal-details" class="approval-details"></div>
        </div>
        <div class="modal-footer" id="approval-modal-footer">
          <!-- Session override dropdown -->
          <div class="session-override-group" id="session-override-group">
            <button
              class="btn btn-ghost btn-sm"
              id="session-override-btn"
              title="Approve all requests for a limited time"
            >
              ⏱ Allow all…
            </button>
            <div class="session-override-menu" id="session-override-menu" style="display: none">
              <button class="session-override-opt" data-minutes="30">30 minutes</button>
              <button class="session-override-opt" data-minutes="60">1 hour</button>
              <button class="session-override-opt" data-minutes="120">2 hours</button>
            </div>
          </div>
          <button class="btn btn-secondary" id="approval-deny-btn">Deny</button>
          <!-- Type-to-confirm container (hidden by default, shown for critical commands) -->
          <div class="approval-type-confirm" id="approval-type-confirm" style="display: none">
            <label class="approval-type-label">Type <strong>ALLOW</strong> to approve:</label>
            <input
              type="text"
              class="form-input approval-type-input"
              id="approval-type-input"
              placeholder="Type ALLOW"
              autocomplete="off"
              spellcheck="false"
            />
          </div>
          <button class="btn btn-primary" id="approval-allow-btn">Allow</button>
        </div>
      </div>
    </div>

    <!-- Generic Confirm Modal (replaces window.confirm which doesn't work in Tauri webview) -->
    <div class="modal-overlay" id="confirm-modal" style="display: none; z-index: 10000">
      <div class="modal-card" style="width: 420px">
        <div class="modal-header">
          <h2 class="modal-title" id="confirm-modal-title">Confirm</h2>
          <button class="btn-icon" id="confirm-modal-close">✕</button>
        </div>
        <div class="modal-body">
          <p id="confirm-modal-message" style="margin: 0; white-space: pre-wrap"></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="confirm-modal-cancel">Cancel</button>
          <button class="btn btn-danger" id="confirm-modal-ok">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Generic Prompt Modal (replaces window.prompt which doesn't work in Tauri webview) -->
    <div class="modal-overlay" id="prompt-modal" style="display: none; z-index: 10000">
      <div class="modal-card" style="width: 420px">
        <div class="modal-header">
          <h2 class="modal-title" id="prompt-modal-title">Input</h2>
          <button class="btn-icon" id="prompt-modal-close">✕</button>
        </div>
        <div class="modal-body">
          <input
            type="text"
            class="form-input"
            id="prompt-modal-input"
            placeholder=""
            autocomplete="off"
          />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="prompt-modal-cancel">Cancel</button>
          <button class="btn btn-primary" id="prompt-modal-ok">OK</button>
        </div>
      </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
